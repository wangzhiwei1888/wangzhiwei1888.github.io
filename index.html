<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="javascript nodejs web developer...">
<meta property="og:type" content="website">
<meta property="og:title" content="WBlog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="WBlog">
<meta property="og:description" content="javascript nodejs web developer...">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="wangzhiwei">
<meta property="article:tag" content="javascript nodejs web developer fe engineer">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>WBlog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">WBlog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">wangzhiwei blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/12/10/Dify-mcp-%E9%93%BE%E8%B7%AF%E6%89%93%E9%80%9A%E8%B0%83%E6%95%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangzhiwei">
      <meta itemprop="description" content="javascript nodejs web developer...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/12/10/Dify-mcp-%E9%93%BE%E8%B7%AF%E6%89%93%E9%80%9A%E8%B0%83%E6%95%B4/" class="post-title-link" itemprop="url">Dify mcp 链路打通调整</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-12-10 17:39:02 / 修改时间：17:47:01" itemprop="dateCreated datePublished" datetime="2025-12-10T17:39:02+08:00">2025-12-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Dify-mcp-链路打通调整"><a href="#Dify-mcp-链路打通调整" class="headerlink" title="Dify mcp 链路打通调整"></a>Dify mcp 链路打通调整</h2><h3 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h3><p><a target="_blank" rel="noopener" href="https://github.com/langgenius/dify/issues/28224">https://github.com/langgenius/dify/issues/28224</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=kLKn3_tj70s">https://www.youtube.com/watch?v=kLKn3_tj70s</a></p>
<h3 id="dify应用的集成"><a href="#dify应用的集成" class="headerlink" title="dify应用的集成"></a>dify应用的集成</h3><p>通过获取登录后接口返回的 user_uuid，进行编码，编码为符合dify要求的格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">user:&#123;&quot;user_uuid&quot;:&quot;c23afa76-c1d0-4980-ab00-9c041409b034&quot;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async function compressAndEncodeBase64(input: string) &#123;</span><br><span class="line">  const uint8Array = (new TextEncoder()).encode(input);</span><br><span class="line">  const compressedStream = new Response(</span><br><span class="line">    new Blob([uint8Array]).stream().pipeThrough(new CompressionStream(&quot;gzip&quot;))</span><br><span class="line">  ).arrayBuffer();</span><br><span class="line">  const compressedUint8Array = new Uint8Array(await compressedStream);</span><br><span class="line">  return btoa(String.fromCharCode(...compressedUint8Array));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//编码为符合dify要求的格式</span><br><span class="line">compressAndEncodeBase64(&#x27;c23afa76-c1d0-4980-ab00-9c041409b034&#x27;, then(code) =&gt; &#123;</span><br><span class="line">    console.log(code);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//根据上一步生成的code,拼接最终的url参数 sys.user_id</span><br><span class="line">https://xxxxxx:8080/chatbot/DpIAYCqQAtgSpHSc?sys.user_id=H4sIAAAAAAAAE0s2Mk5MSzQ30002TDHQNbG0MNBNTDIw0LVMNjAxNDGwTDIwNgEA0UXx2iQAAAA=</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="参考文档：-1"><a href="#参考文档：-1" class="headerlink" title="参考文档："></a>参考文档：</h3><p><a target="_blank" rel="noopener" href="https://github.com/langgenius/dify/pull/27524">https://github.com/langgenius/dify/pull/27524</a><br><a target="_blank" rel="noopener" href="https://github.com/langgenius/dify/issues/27468">https://github.com/langgenius/dify/issues/27468</a></p>
<h3 id="链路打通的最新抓包文件"><a href="#链路打通的最新抓包文件" class="headerlink" title="链路打通的最新抓包文件"></a>链路打通的最新抓包文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">uuid: c23afa76-c1d0-4980-ab00-9c041409b034</span><br><span class="line">POST /mcp HTTP/1.1</span><br><span class="line">Host: 192.168.40.211:18080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: python-httpx/0.27.2</span><br><span class="line">uuid: c23afa76-c1d0-4980-ab00-9c041409b034</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: application/json, text/event-stream</span><br><span class="line">Content-Length: 190</span><br><span class="line"></span><br><span class="line">&#123;&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 0, &quot;method&quot;: &quot;initialize&quot;, &quot;params&quot;: &#123;&quot;protocolVersion&quot;: &quot;2024-11-05&quot;, &quot;capabilities&quot;: &#123;&#125;, &quot;clientInfo&quot;: &#123;&quot;name&quot;: &quot;MCP Streamable HTTP Client&quot;, &quot;version&quot;: &quot;1.0.0&quot;&#125;&#125;&#125;</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: njet/4.0.0.0</span><br><span class="line">Date: Wed, 10 Dec 2025 06:27:21 GMT</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Length: 277</span><br><span class="line">Mcp-Session-Id: aTkSyQiJwOoCAAB9</span><br><span class="line"></span><br><span class="line">&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&#123;&quot;protocolVersion&quot;:&quot;2024-11-05&quot;,&quot;serverInfo&quot;:&#123;&quot;name&quot;:&quot;lua-resty-mcp&quot;,&quot;version&quot;:&quot;2.0&quot;&#125;,&quot;capabilities&quot;:&#123;&quot;completions&quot;:&#123;&#125;,&quot;prompts&quot;:&#123;&quot;listChanged&quot;:true&#125;,&quot;logging&quot;:&#123;&#125;,&quot;tools&quot;:&#123;&quot;listChanged&quot;:true&#125;,&quot;resources&quot;:&#123;&quot;listChanged&quot;:true,&quot;subscribe&quot;:true&#125;&#125;&#125;,&quot;id&quot;:0&#125;</span><br><span class="line">POST /mcp HTTP/1.1</span><br><span class="line">Host: 192.168.40.211:18080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: python-httpx/0.27.2</span><br><span class="line">uuid: c23afa76-c1d0-4980-ab00-9c041409b034</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: application/json, text/event-stream</span><br><span class="line">Mcp-Session-Id: aTkSyQiJwOoCAAB9</span><br><span class="line">Content-Length: 71</span><br><span class="line"></span><br><span class="line">&#123;&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;notifications/initialized&quot;, &quot;params&quot;: &#123;&#125;&#125;</span><br><span class="line">HTTP/1.1 202 Accepted</span><br><span class="line">Server: njet/4.0.0.0</span><br><span class="line">Date: Wed, 10 Dec 2025 06:27:21 GMT</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /mcp HTTP/1.1</span><br><span class="line">Host: 192.168.40.211:18080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: python-httpx/0.27.2</span><br><span class="line">uuid: c23afa76-c1d0-4980-ab00-9c041409b034</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: application/json, text/event-stream</span><br><span class="line">Mcp-Session-Id: aTkSyQiJwOoCAAB9</span><br><span class="line">Content-Length: 65</span><br><span class="line"></span><br><span class="line">&#123;&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 1, &quot;method&quot;: &quot;tools/list&quot;, &quot;params&quot;: &#123;&#125;&#125;</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: njet/4.0.0.0</span><br><span class="line">Date: Wed, 10 Dec 2025 06:27:21 GMT</span><br><span class="line">Content-Type: text/event-stream</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: no-store, no-transform</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">data:&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&#123;&quot;tools&quot;:[&#123;&quot;name&quot;:&quot;echo&quot;,&quot;inputSchema&quot;:&#123;&quot;required&quot;:[&quot;message&quot;],&quot;type&quot;:&quot;object&quot;,&quot;properties&quot;:&#123;&quot;message&quot;:&#123;&quot;type&quot;:&quot;string&quot;&#125;&#125;&#125;,&quot;description&quot;:&quot;Echo a message as a tool&quot;&#125;,&#123;&quot;name&quot;:&quot;exp&quot;,&quot;inputSchema&quot;:&#123;&quot;required&quot;:[&quot;inputA&quot;,&quot;oper&quot;,&quot;inputB&quot;],&quot;type&quot;:&quot;object&quot;,&quot;properties&quot;:&#123;&quot;inputB&quot;:&#123;&quot;type&quot;:&quot;number&quot;&#125;,&quot;oper&quot;:&#123;&quot;type&quot;:&quot;string&quot;&#125;,&quot;inputA&quot;:&#123;&quot;type&quot;:&quot;number&quot;&#125;&#125;&#125;,&quot;description&quot;:&quot;a tool to calculate math expressions, like 1+1=?&quot;&#125;]&#125;,&quot;id&quot;:1&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /mcp HTTP/1.1</span><br><span class="line">Host: 192.168.40.211:18080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: python-httpx/0.27.2</span><br><span class="line">uuid: c23afa76-c1d0-4980-ab00-9c041409b034</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: application/json, text/event-stream</span><br><span class="line">Mcp-Session-Id: aTkSyQiJwOoCAAB9</span><br><span class="line">Content-Length: 111</span><br><span class="line"></span><br><span class="line">&#123;&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 2, &quot;method&quot;: &quot;tools/call&quot;, &quot;params&quot;: &#123;&quot;name&quot;: &quot;echo&quot;, &quot;arguments&quot;: &#123;&quot;message&quot;: &quot;aa&quot;&#125;&#125;&#125;</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: njet/4.0.0.0</span><br><span class="line">Date: Wed, 10 Dec 2025 06:27:24 GMT</span><br><span class="line">Content-Type: text/event-stream</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: no-store, no-transform</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">data:&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&#123;&quot;content&quot;:[&#123;&quot;text&quot;:&quot;Tool echo: aa&quot;,&quot;type&quot;:&quot;text&quot;&#125;]&#125;,&quot;id&quot;:2&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /mcp HTTP/1.1</span><br><span class="line">Host: 192.168.40.211:18080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: python-httpx/0.27.2</span><br><span class="line">uuid: c23afa76-c1d0-4980-ab00-9c041409b034</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: application/json, text/event-stream</span><br><span class="line">Mcp-Session-Id: aTkSyQiJwOoCAAB9</span><br><span class="line">Content-Length: 111</span><br><span class="line"></span><br><span class="line">&#123;&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 3, &quot;method&quot;: &quot;tools/call&quot;, &quot;params&quot;: &#123;&quot;name&quot;: &quot;echo&quot;, &quot;arguments&quot;: &#123;&quot;message&quot;: &quot;aa&quot;&#125;&#125;&#125;</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: njet/4.0.0.0</span><br><span class="line">Date: Wed, 10 Dec 2025 06:27:27 GMT</span><br><span class="line">Content-Type: text/event-stream</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: no-store, no-transform</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">data:&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&#123;&quot;content&quot;:[&#123;&quot;text&quot;:&quot;Tool echo: aa&quot;,&quot;type&quot;:&quot;text&quot;&#125;]&#125;,&quot;id&quot;:3&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /mcp HTTP/1.1</span><br><span class="line">Host: 192.168.40.211:18080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: python-httpx/0.27.2</span><br><span class="line">uuid: c23afa76-c1d0-4980-ab00-9c041409b034</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: application/json, text/event-stream</span><br><span class="line">Mcp-Session-Id: aTkSyQiJwOoCAAB9</span><br><span class="line">Content-Length: 111</span><br><span class="line"></span><br><span class="line">&#123;&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 4, &quot;method&quot;: &quot;tools/call&quot;, &quot;params&quot;: &#123;&quot;name&quot;: &quot;echo&quot;, &quot;arguments&quot;: &#123;&quot;message&quot;: &quot;aa&quot;&#125;&#125;&#125;</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: njet/4.0.0.0</span><br><span class="line">Date: Wed, 10 Dec 2025 06:27:30 GMT</span><br><span class="line">Content-Type: text/event-stream</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: no-store, no-transform</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">data:&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&#123;&quot;content&quot;:[&#123;&quot;text&quot;:&quot;Tool echo: aa&quot;,&quot;type&quot;:&quot;text&quot;&#125;]&#125;,&quot;id&quot;:4&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /mcp HTTP/1.1</span><br><span class="line">Host: 192.168.40.211:18080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: python-httpx/0.27.2</span><br><span class="line">uuid: c23afa76-c1d0-4980-ab00-9c041409b034</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: application/json, text/event-stream</span><br><span class="line">Mcp-Session-Id: aTkSyQiJwOoCAAB9</span><br><span class="line">Content-Length: 111</span><br><span class="line"></span><br><span class="line">&#123;&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 5, &quot;method&quot;: &quot;tools/call&quot;, &quot;params&quot;: &#123;&quot;name&quot;: &quot;echo&quot;, &quot;arguments&quot;: &#123;&quot;message&quot;: &quot;aa&quot;&#125;&#125;&#125;</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: njet/4.0.0.0</span><br><span class="line">Date: Wed, 10 Dec 2025 06:27:33 GMT</span><br><span class="line">Content-Type: text/event-stream</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: no-store, no-transform</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">data:&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&#123;&quot;content&quot;:[&#123;&quot;text&quot;:&quot;Tool echo: aa&quot;,&quot;type&quot;:&quot;text&quot;&#125;]&#125;,&quot;id&quot;:5&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /mcp HTTP/1.1</span><br><span class="line">Host: 192.168.40.211:18080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: python-httpx/0.27.2</span><br><span class="line">uuid: c23afa76-c1d0-4980-ab00-9c041409b034</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept: application/json, text/event-stream</span><br><span class="line">Mcp-Session-Id: aTkSyQiJwOoCAAB9</span><br><span class="line">Content-Length: 111</span><br><span class="line"></span><br><span class="line">&#123;&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;: 6, &quot;method&quot;: &quot;tools/call&quot;, &quot;params&quot;: &#123;&quot;name&quot;: &quot;echo&quot;, &quot;arguments&quot;: &#123;&quot;message&quot;: &quot;aa&quot;&#125;&#125;&#125;</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: njet/4.0.0.0</span><br><span class="line">Date: Wed, 10 Dec 2025 06:27:36 GMT</span><br><span class="line">Content-Type: text/event-stream</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: no-store, no-transform</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">data:&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&#123;&quot;content&quot;:[&#123;&quot;text&quot;:&quot;Tool echo: aa&quot;,&quot;type&quot;:&quot;text&quot;&#125;]&#125;,&quot;id&quot;:6&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>另外一种方法是自己调用一下 dify 的 passport 接口，将 user_id 传给 dify. 待验证。</p>
<p><img src="/../images/mcp01.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/12/08/dify-X-App-Passport-%E4%B8%AD-end-user-id-%E6%89%93%E9%80%9A%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangzhiwei">
      <meta itemprop="description" content="javascript nodejs web developer...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/12/08/dify-X-App-Passport-%E4%B8%AD-end-user-id-%E6%89%93%E9%80%9A%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%BF%E9%97%AE%E9%93%BE%E8%B7%AF/" class="post-title-link" itemprop="url">dify X-App-Passport 中 end_user_id 打通大模型访问链路</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-12-08 11:43:19 / 修改时间：11:50:29" itemprop="dateCreated datePublished" datetime="2025-12-08T11:43:19+08:00">2025-12-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="dify-X-App-Passport-中-end-user-id-打通大模型访问链路"><a href="#dify-X-App-Passport-中-end-user-id-打通大模型访问链路" class="headerlink" title="dify X-App-Passport 中 end_user_id 打通大模型访问链路"></a>dify X-App-Passport 中 end_user_id 打通大模型访问链路</h2><p>前端解密用到了 jose ，需要对X-App-Passport ，进行解密，解密需要在 https环境下，否则揭秘方法会报错。</p>
<p>dify应用，调用dify 自己的 chat 接口，会传递 X-App-Passport ，</p>
<p><img src="/../images/dify01.jpeg"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">useEffect(() =&gt; &#123;</span><br><span class="line">    if (iframeLoaded) &#123;</span><br><span class="line">      setTimeout(async() =&gt; &#123;        </span><br><span class="line">        const passport = localStorage.getItem(&#x27;passport-&#x27; + chatId) || &#x27;&#x27;;</span><br><span class="line">        console.log(passport);</span><br><span class="line"></span><br><span class="line">        if (passport) &#123;</span><br><span class="line">          const secret = new TextEncoder().encode(&#x27;sk-xxxxxxxxxxx&#x27;);</span><br><span class="line">          // 验签</span><br><span class="line">          try &#123;</span><br><span class="line">            const &#123; payload &#125; = await jose.jwtVerify(passport, secret, &#123;</span><br><span class="line">              algorithms: [&#x27;HS256&#x27;],</span><br><span class="line">            &#125;);</span><br><span class="line">            // console.log(payload);</span><br><span class="line">            // alert(JSON.stringify(payload));</span><br><span class="line"></span><br><span class="line">            const userStr = localStorage.getItem(&#x27;user&#x27;);</span><br><span class="line">            const user = userStr ? JSON.parse(userStr) : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">            setEndUserId(user.user_uuid as string, payload.end_user_id as string)</span><br><span class="line">            .then((res) =&gt; &#123;</span><br><span class="line">              console.log(&#x27;set end user id success&#x27;, res);</span><br><span class="line">            &#125;)</span><br><span class="line">            .catch((err) =&gt; &#123;</span><br><span class="line">              console.error(&#x27;set end user id failed&#x27;, err);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">          &#125; catch (e) &#123;</span><br><span class="line">            console.error(&#x27;invalid&#x27;, e);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">      &#125;, 1000)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [iframeLoaded]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>X-App-Passport 解析后含有以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    iss: &#x27;d1b66a51-b4ef-45ef-b3bf-7b5813c86261&#x27;, </span><br><span class="line">    sub: &#x27;Web API Passport&#x27;, </span><br><span class="line">    app_id: &#x27;d1b66a51-b4ef-45ef-b3bf-7b5813c86261&#x27;, </span><br><span class="line">    app_code: &#x27;j0xH9mK60ZS5mI70&#x27;, </span><br><span class="line">    end_user_id: &#x27;239b5e72-7cfd-4a25-930d-de68a3f41764&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点关注end_user_id，dify会将其发送给大模型的请求体中。抓包可以看到如下信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /v1/chat/completions HTTP/1.1</span><br><span class="line">Host: 192.168.0.209:8080</span><br><span class="line">User-Agent: python-requests/2.32.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept-Charset: utf-8</span><br><span class="line">Authorization: Bearer vllm</span><br><span class="line">Content-Length: 227</span><br><span class="line"></span><br><span class="line">&#123;&quot;model&quot;: &quot;Qwen3-14B&quot;, &quot;stream&quot;: true, &quot;temperature&quot;: 0.7, &quot;messages&quot;: [&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;85f7cfff-90fe-4248-b41a-f60c56d8efb3&quot;&#125;, &#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;a\n\n&quot;&#125;], &quot;user&quot;: &quot;85f7cfff-90fe-4248-b41a-f60c56d8efb3&quot;&#125;</span><br></pre></td></tr></table></figure>


<p>X-App-Passport 内容格式如下，我们可以通过拆分下面的字符串，获取中间部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJkMWI2NmE1MS1iNGVmLTQ1ZWYtYjNiZi03YjU4MTNjODYyNjEiLCJzdWIiOiJXZWIgQVBJIFBhc3Nwb3J0IiwiYXBwX2lkIjoiZDFiNjZhNTEtYjRlZi00NWVmLWIzYmYtN2I1ODEzYzg2MjYxIiwiYXBwX2NvZGUiOiJqMHhIOW1LNjBaUzVtSTcwIiwiZW5kX3VzZXJfaWQiOiIyMzliNWU3Mi03Y2ZkLTRhMjUtOTMwZC1kZTY4YTNmNDE3NjQifQ.eb0j1nJaPXvB5ZFLLlopQu-PwkvAHSvWlqnaaG2d6ms</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// 1. 把 URL-safe 字符 (- _) 换回标准 (+ /)</span><br><span class="line">const urlSafe = &#x27;eyJpc3MiOiJkMWI2NmE1MS1iNGVmLTQ1ZWYtYjNiZi03YjU4MTNjODYyNjEiLCJzdWIiOiJXZWIgQVBJIFBhc3Nwb3J0IiwiYXBwX2lkIjoiZDFiNjZhNTEtYjRlZi00NWVmLWIzYmYtN2I1ODEzYzg2MjYxIiwiYXBwX2NvZGUiOiJqMHhIOW1LNjBaUzVtSTcwIiwiZW5kX3VzZXJfaWQiOiIyMzliNWU3Mi03Y2ZkLTRhMjUtOTMwZC1kZTY4YTNmNDE3NjQifQ&#x27;;</span><br><span class="line">const standard = urlSafe.replace(/-/g, &#x27;+&#x27;).replace(/_/g, &#x27;/&#x27;);</span><br><span class="line"></span><br><span class="line">// 2. 解码</span><br><span class="line">const jsonStr = decodeURIComponent(</span><br><span class="line">  Array.prototype.map.call(</span><br><span class="line">    atob(standard),</span><br><span class="line">    c =&gt; &#x27;%&#x27; + (&#x27;00&#x27; + c.charCodeAt(0).toString(16)).slice(-2)</span><br><span class="line">  ).join(&#x27;&#x27;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">console.log(jsonStr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;iss&quot;: &quot;d1b66a51-b4ef-45ef-b3bf-7b5813c86261&quot;,</span><br><span class="line">  &quot;sub&quot;: &quot;Web API Passport&quot;,</span><br><span class="line">  &quot;app_id&quot;: &quot;d1b66a51-b4ef-45ef-b3bf-7b5813c86261&quot;,</span><br><span class="line">  &quot;app_code&quot;: &quot;j0xH9mK60ZS5mI70&quot;,</span><br><span class="line">  &quot;end_user_id&quot;: &quot;239b5e72-7cfd-4a25-930d-de68a3f41764&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>拓展对字符进行base64加密</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 加密：普通字符串 → Base64</span><br><span class="line">function base64Encode(str) &#123;</span><br><span class="line">  return btoa(</span><br><span class="line">    encodeURIComponent(str)</span><br><span class="line">      .replace(/%([0-9A-F]&#123;2&#125;)/g, (_, p1) =&gt;</span><br><span class="line">        String.fromCharCode(&#x27;0x&#x27; + p1)</span><br><span class="line">      )</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* ---- 用例 ---- */</span><br><span class="line">const json = JSON.stringify(&#123;</span><br><span class="line">  iss: &quot;d1b66a51-b4ef-45ef-b3bf-7b5813c86261&quot;,</span><br><span class="line">  sub: &quot;Web API Passport&quot;,</span><br><span class="line">  app_id: &quot;d1b66a51-b4ef-45ef-b3bf-7b5813c86261&quot;,</span><br><span class="line">  app_code: &quot;j0xH9mK60ZS5mI70&quot;,</span><br><span class="line">  end_user_id: &quot;239b5e72-7cfd-4a25-930d-de68a3f41764&quot;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">console.log(base64Encode(json));</span><br><span class="line">// 输出：</span><br><span class="line">// eyJpc3MiOiJkMWI2NmE1MS1iNGVmLTQ1ZWYtYjNiZi03YjU4MTNjODYyNjEiLCJzdWIiOiJXZWIgQVBJIFBhc3Nwb3J0IiwiYXBwX2lkIjoiZDFiNjZhNTEtYjRlZi00NWVmLWIzYmYtN2I1ODEzYzg2MjYxIiwiYXBwX2NvZGUiOiJqMHhIOW1LNjBaUzVtSTcwIiwiZW5kX3VzZXJfaWQiOiIyMzliNWU3Mi03Y2ZkLTRhMjUtOTMwZC1kZTY4YTNmNDE3NjQifQ</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/11/25/nodejs-mcp-study/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangzhiwei">
      <meta itemprop="description" content="javascript nodejs web developer...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/11/25/nodejs-mcp-study/" class="post-title-link" itemprop="url">nodejs mcp study</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-11-25 17:54:01 / 修改时间：18:06:24" itemprop="dateCreated datePublished" datetime="2025-11-25T17:54:01+08:00">2025-11-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="nodejs-mcp"><a href="#nodejs-mcp" class="headerlink" title="nodejs mcp"></a>nodejs mcp</h2><p>package.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;nodejs-mcp-server&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class="line">  &quot;main&quot;: &quot;server.js&quot;,</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;,</span><br><span class="line">    &quot;start&quot;: &quot;node server.js&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;keywords&quot;: [],</span><br><span class="line">  &quot;author&quot;: &quot;&quot;,</span><br><span class="line">  &quot;license&quot;: &quot;ISC&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;&quot;,</span><br><span class="line">  &quot;dependencies&quot;: &#123;</span><br><span class="line">    &quot;@modelcontextprotocol/sdk&quot;: &quot;^1.22.0&quot;,</span><br><span class="line">    &quot;express&quot;: &quot;^5.1.0&quot;,</span><br><span class="line">    &quot;zod&quot;: &quot;^3.24.1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;type&quot;: &quot;module&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以文件的形式提供mcp服务<br>server.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">import &#123; McpServer, ResourceTemplate &#125; from &#x27;@modelcontextprotocol/sdk/server/mcp.js&#x27;;</span><br><span class="line">import &#123; StdioServerTransport &#125; from &#x27;@modelcontextprotocol/sdk/server/stdio.js&#x27;;</span><br><span class="line">import * as z from &#x27;zod&#x27;;</span><br><span class="line"></span><br><span class="line">const server = new McpServer(&#123;</span><br><span class="line">    name: &#x27;demo-server&#x27;,</span><br><span class="line">    version: &#x27;1.0.0&#x27;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 工具1：笑话（修复版）</span><br><span class="line">server.registerTool(</span><br><span class="line">    &#x27;tell_weird_joke&#x27;,</span><br><span class="line">    &#123;</span><br><span class="line">        title: &#x27;Tell Weird Joke&#x27;,</span><br><span class="line">        description: &#x27;Generate a weird joke about a specified topic&#x27;,</span><br><span class="line">        inputSchema: z.object(&#123;  // 修复：必须使用 z.object()</span><br><span class="line">            topic: z.string().describe(&#x27;The topic of the joke&#x27;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    async (&#123; topic &#125;) =&gt; &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            content: [&#123; type: &#x27;text&#x27;, text: `The weirdest joke about $&#123;topic&#125; is... hahaha!` &#125;],</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// 工具2：加法（修复版）</span><br><span class="line">server.registerTool(</span><br><span class="line">    &#x27;add&#x27;,</span><br><span class="line">    &#123;</span><br><span class="line">        title: &#x27;Addition Tool&#x27;,</span><br><span class="line">        description: &#x27;Add two numbers&#x27;,</span><br><span class="line">        inputSchema: z.object(&#123;  // 修复：必须使用 z.object()</span><br><span class="line">            a: z.number(),</span><br><span class="line">            b: z.number()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    async (&#123; a, b &#125;) =&gt; &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            content: [&#123; type: &#x27;text&#x27;, text: `Result: $&#123;a + b&#125;` &#125;],</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// 资源：问候</span><br><span class="line">server.registerResource(</span><br><span class="line">    &#x27;greeting&#x27;,</span><br><span class="line">    new ResourceTemplate(&#x27;greeting://&#123;name&#125;&#x27;, &#123; list: undefined &#125;),</span><br><span class="line">    &#123; title: &#x27;Greeting Resource&#x27;, description: &#x27;Dynamic greeting generator&#x27; &#125;,</span><br><span class="line">    async (uri, &#123; name &#125;) =&gt; (&#123;</span><br><span class="line">        contents: [&#123; uri: uri.href, text: `Hello, $&#123;name&#125;!` &#125;]</span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// 启动</span><br><span class="line">async function main() &#123;</span><br><span class="line">    const transport = new StdioServerTransport();</span><br><span class="line">    await server.connect(transport);</span><br><span class="line">    console.error(&#x27;✅ MCP 服务器已启动&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">main().catch(console.error);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>npx @modelcontextprotocol&#x2F;inspector nodejs server.js</p>
<p><img src="/../images/mcp001.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&quot;tell_weird_joke&quot;: &#123;</span><br><span class="line">      &quot;isActive&quot;: true,</span><br><span class="line">      &quot;name&quot;: &quot;tell_weird_joke&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;stdio&quot;,</span><br><span class="line">      &quot;command&quot;: &quot;node&quot;,</span><br><span class="line">      &quot;args&quot;: [</span><br><span class="line">        &quot;/Users/wangzhiwei/work/ai-getway-study/nodejs-mcp-server/server.js&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;installSource&quot;: &quot;unknown&quot;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>


<p>以http端点的形式提供 mcp 服务<br>server2.js </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">import &#123; McpServer, ResourceTemplate &#125; from &#x27;@modelcontextprotocol/sdk/server/mcp.js&#x27;;</span><br><span class="line">import &#123; StreamableHTTPServerTransport &#125; from &#x27;@modelcontextprotocol/sdk/server/streamableHttp.js&#x27;;</span><br><span class="line">import express from &#x27;express&#x27;;</span><br><span class="line">import * as z from &#x27;zod&#x27;;</span><br><span class="line"></span><br><span class="line">// 1. 创建 MCP 服务器（保持不变）</span><br><span class="line">const server = new McpServer(&#123;</span><br><span class="line">    name: &#x27;demo-server&#x27;,</span><br><span class="line">    version: &#x27;1.0.0&#x27;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 2. 注册所有工具和资源（保持不变）</span><br><span class="line">server.registerTool(</span><br><span class="line">    &#x27;tell_weird_joke&#x27;,</span><br><span class="line">    &#123;</span><br><span class="line">        title: &#x27;Tell Weird Joke&#x27;,</span><br><span class="line">        description: &#x27;Generate a weird joke about a specified topic&#x27;,</span><br><span class="line">        inputSchema: z.object(&#123;</span><br><span class="line">            topic: z.string().describe(&#x27;The topic of the joke&#x27;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    async (&#123; topic &#125;) =&gt; &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            content: [&#123; type: &#x27;text&#x27;, text: `The weirdest joke about $&#123;topic&#125; is... hahaha!` &#125;],</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">server.registerTool(</span><br><span class="line">    &#x27;add&#x27;,</span><br><span class="line">    &#123;</span><br><span class="line">        title: &#x27;Addition Tool&#x27;,</span><br><span class="line">        description: &#x27;Add two numbers&#x27;,</span><br><span class="line">        inputSchema: z.object(&#123;</span><br><span class="line">            a: z.number(),</span><br><span class="line">            b: z.number()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    async (&#123; a, b &#125;) =&gt; &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            content: [&#123; type: &#x27;text&#x27;, text: `Result: $&#123;a + b&#125;` &#125;],</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">server.registerResource(</span><br><span class="line">    &#x27;greeting&#x27;,</span><br><span class="line">    new ResourceTemplate(&#x27;greeting://&#123;name&#125;&#x27;, &#123; list: undefined &#125;),</span><br><span class="line">    &#123; title: &#x27;Greeting Resource&#x27;, description: &#x27;Dynamic greeting generator&#x27; &#125;,</span><br><span class="line">    async (uri, &#123; name &#125;) =&gt; (&#123;</span><br><span class="line">        contents: [&#123; uri: uri.href, text: `Hello, $&#123;name&#125;!` &#125;]</span><br><span class="line">    &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">// 3. 创建 Express 应用</span><br><span class="line">const app = express();</span><br><span class="line">app.use(express.json());</span><br><span class="line"></span><br><span class="line">// 4. 添加健康检查端点（可选）</span><br><span class="line">app.get(&#x27;/health&#x27;, (req, res) =&gt; &#123;</span><br><span class="line">    res.json(&#123; status: &#x27;ok&#x27;, timestamp: new Date().toISOString() &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 5. 核心 MCP HTTP 端点</span><br><span class="line">app.post(&#x27;/mcp&#x27;, async (req, res) =&gt; &#123;</span><br><span class="line">    // 每个请求创建独立 transport 实例（避免请求 ID 冲突）</span><br><span class="line">    const transport = new StreamableHTTPServerTransport(&#123;</span><br><span class="line">        sessionIdGenerator: undefined,</span><br><span class="line">        enableJsonResponse: true // 启用 JSON 响应格式</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    // 请求结束时清理资源</span><br><span class="line">    res.on(&#x27;close&#x27;, () =&gt; &#123;</span><br><span class="line">        transport.close();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">        // 将 transport 连接到 MCP 服务器</span><br><span class="line">        await server.connect(transport);</span><br><span class="line">        </span><br><span class="line">        // 处理请求并返回响应</span><br><span class="line">        await transport.handleRequest(req, res, req.body);</span><br><span class="line">    &#125; catch (error) &#123;</span><br><span class="line">        console.error(&#x27;❌ MCP request error:&#x27;, error);</span><br><span class="line">        if (!res.headersSent) &#123;</span><br><span class="line">            res.status(500).json(&#123; error: &#x27;Internal server error&#x27; &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 6. 启动 HTTP 服务器</span><br><span class="line">const port = parseInt(process.env.PORT || &#x27;3000&#x27;);</span><br><span class="line">app.listen(port, () =&gt; &#123;</span><br><span class="line">    console.log(`🚀 MCP HTTP Server running at http://localhost:$&#123;port&#125;`);</span><br><span class="line">    console.log(`📡 MCP endpoint: http://localhost:$&#123;port&#125;/mcp`);</span><br><span class="line">    console.log(`🏥 Health check: http://localhost:$&#123;port&#125;/health`);</span><br><span class="line">&#125;).on(&#x27;error&#x27;, error =&gt; &#123;</span><br><span class="line">    console.error(&#x27;❌ Server error:&#x27;, error);</span><br><span class="line">    process.exit(1);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="运行-1"><a href="#运行-1" class="headerlink" title="运行"></a>运行</h2><p>node server2.js</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:3000/health</span><br><span class="line">&#123;&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:&quot;2025-11-25T10:00:07.470Z&quot;&#125;%</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:3000/mcp \</span><br><span class="line">  -H &quot;Content-Type: application/json&quot; \</span><br><span class="line">  -d &#x27;&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;method&quot;:&quot;tools/list&quot;,&quot;params&quot;:&#123;&#125;&#125;&#x27;</span><br><span class="line">&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;error&quot;:&#123;&quot;code&quot;:-32000,&quot;message&quot;:&quot;Not Acceptable: Client must accept both application/json and text/event-stream&quot;&#125;,&quot;id&quot;:null&#125;%</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:3000/mcp \</span><br><span class="line">  -H &quot;Content-Type: application/json&quot; \</span><br><span class="line">  -H &quot;Accept: application/json, text/event-stream&quot; \</span><br><span class="line">  -d &#x27;&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;method&quot;:&quot;tools/list&quot;,&quot;params&quot;:&#123;&#125;&#125;&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#123;&quot;result&quot;:&#123;&quot;tools&quot;:[&#123;&quot;name&quot;:&quot;tell_weird_joke&quot;,&quot;title&quot;:&quot;Tell Weird Joke&quot;,&quot;description&quot;:&quot;Generate a weird joke about a specified topic&quot;,&quot;inputSchema&quot;:&#123;&quot;type&quot;:&quot;object&quot;,&quot;properties&quot;:&#123;&quot;topic&quot;:&#123;&quot;type&quot;:&quot;string&quot;,&quot;description&quot;:&quot;The topic of the joke&quot;&#125;&#125;,&quot;required&quot;:[&quot;topic&quot;],&quot;additionalProperties&quot;:false,&quot;$schema&quot;:&quot;http://json-schema.org/draft-07/schema#&quot;&#125;&#125;,&#123;&quot;name&quot;:&quot;add&quot;,&quot;title&quot;:&quot;Addition Tool&quot;,&quot;description&quot;:&quot;Add two numbers&quot;,&quot;inputSchema&quot;:&#123;&quot;type&quot;:&quot;object&quot;,&quot;properties&quot;:&#123;&quot;a&quot;:&#123;&quot;type&quot;:&quot;number&quot;&#125;,&quot;b&quot;:&#123;&quot;type&quot;:&quot;number&quot;&#125;&#125;,&quot;required&quot;:[&quot;a&quot;,&quot;b&quot;],&quot;additionalProperties&quot;:false,&quot;$schema&quot;:&quot;http://json-schema.org/draft-07/schema#&quot;&#125;&#125;]&#125;,&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1&#125;%</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:3000/mcp \</span><br><span class="line">  -H &quot;Content-Type: application/json&quot; \</span><br><span class="line">  -H &quot;Accept: application/json, text/event-stream&quot; \</span><br><span class="line">  -d &#x27;&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:2,&quot;method&quot;:&quot;tools/call&quot;,&quot;params&quot;:&#123;&quot;name&quot;:&quot;add&quot;,&quot;arguments&quot;:&#123;&quot;a&quot;:5,&quot;b&quot;:3&#125;&#125;&#125;&#x27;</span><br><span class="line"></span><br><span class="line">  &#123;&quot;result&quot;:&#123;&quot;content&quot;:[&#123;&quot;type&quot;:&quot;text&quot;,&quot;text&quot;:&quot;Result: 8&quot;&#125;]&#125;,&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:2&#125;%</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">curl -X POST http://localhost:3000/mcp \</span><br><span class="line">  -H &quot;Content-Type: application/json&quot; \</span><br><span class="line">  -H &quot;Accept: application/json, text/event-stream&quot; \</span><br><span class="line">  -d &#x27;&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:3,&quot;method&quot;:&quot;tools/call&quot;,&quot;params&quot;:&#123;&quot;name&quot;:&quot;tell_weird_joke&quot;,&quot;arguments&quot;:&#123;&quot;topic&quot;:&quot;programming&quot;&#125;&#125;&#125;&#x27;</span><br><span class="line"></span><br><span class="line">&#123;&quot;result&quot;:&#123;&quot;content&quot;:[&#123;&quot;type&quot;:&quot;text&quot;,&quot;text&quot;:&quot;The weirdest joke about programming is... hahaha!&quot;&#125;]&#125;,&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:3&#125;%</span><br></pre></td></tr></table></figure>




<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="https://github.com/modelcontextprotocol/typescript-sdk">https://github.com/modelcontextprotocol/typescript-sdk</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/10/24/nginx-conf-to-json/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangzhiwei">
      <meta itemprop="description" content="javascript nodejs web developer...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/10/24/nginx-conf-to-json/" class="post-title-link" itemprop="url">nginx conf to json</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-10-24 08:57:09 / 修改时间：10:16:21" itemprop="dateCreated datePublished" datetime="2025-10-24T08:57:09+08:00">2025-10-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>python 版本<br>pip install crossplane</p>
<p>crossplane parse –indent&#x3D;4 nginx.conf &gt; nginx.json</p>
<p>crossplane build nginx.json</p>
<p><a target="_blank" rel="noopener" href="https://github.com/nginxinc/crossplane?tab=readme-ov-file#crossplane-parse">https://github.com/nginxinc/crossplane?tab=readme-ov-file#crossplane-parse</a></p>
<h2 id="转换为-js-版本"><a href="#转换为-js-版本" class="headerlink" title="转换为 js 版本"></a>转换为 js 版本</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line">nginx-parser.js</span><br><span class="line"></span><br><span class="line">// nginx config lexer + parser (browser version)</span><br><span class="line">// 用法：</span><br><span class="line">//   import &#123; parseNginx &#125; from &#x27;./nginx-parser.js&#x27;;</span><br><span class="line">//   const payload = parseNginx(nginxText, &#123; filename:&#x27;nginx.conf&#x27;, comments:true &#125;);</span><br><span class="line"></span><br><span class="line">const EXTERNAL_PARSERS = &#123;&#125;;   // 预留第三方指令解析器</span><br><span class="line"></span><br><span class="line">// ---------- lexer ----------</span><br><span class="line">function* lex(text, filename = &#x27;nginx.conf&#x27;) &#123;</span><br><span class="line">  let line = 1, col = 0, idx = 0;</span><br><span class="line">  const len = text.length;</span><br><span class="line"></span><br><span class="line">  function skipWhitespace() &#123;</span><br><span class="line">    while (idx &lt; len &amp;&amp; /\s/.test(text[idx])) &#123;</span><br><span class="line">      if (text[idx] === &#x27;\n&#x27;) &#123; line++; col = 0; &#125;</span><br><span class="line">      else col++;</span><br><span class="line">      idx++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function readString(quote) &#123;</span><br><span class="line">    const start = ++idx;  // skip open quote</span><br><span class="line">    col++;</span><br><span class="line">    while (idx &lt; len &amp;&amp; text[idx] !== quote) &#123;</span><br><span class="line">      if (text[idx] === &#x27;\n&#x27;) &#123; line++; col = 0; &#125;</span><br><span class="line">      else if (text[idx] === &#x27;\\&#x27;) &#123; idx++; col++; &#125; // skip escaped</span><br><span class="line">      idx++; col++;</span><br><span class="line">    &#125;</span><br><span class="line">    if (idx &gt;= len) throw new Error(`Unterminated quoted string at $&#123;filename&#125;:$&#123;line&#125;`);</span><br><span class="line">    const val = text.slice(start, idx);</span><br><span class="line">    idx++; col++; // skip close quote</span><br><span class="line">    return [val, line, true];   // [token, lineno, quoted]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function readToken() &#123;</span><br><span class="line">    const start = idx;</span><br><span class="line">    while (idx &lt; len &amp;&amp; !/\s|[&#123;&#125;;#&quot;&#x27;\\]/.test(text[idx])) &#123;</span><br><span class="line">      idx++; col++;</span><br><span class="line">    &#125;</span><br><span class="line">    return text.slice(start, idx);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  while (idx &lt; len) &#123;</span><br><span class="line">    skipWhitespace();</span><br><span class="line">    if (idx &gt;= len) break;</span><br><span class="line">    const ch = text[idx];</span><br><span class="line"></span><br><span class="line">    if (ch === &#x27;#&#x27; || ch === &#x27;;&#x27; || ch === &#x27;&#123;&#x27; || ch === &#x27;&#125;&#x27;) &#123;</span><br><span class="line">      const tok = ch === &#x27;#&#x27; ? text.slice(idx, text.indexOf(&#x27;\n&#x27;, idx)) || text.slice(idx)</span><br><span class="line">                             : ch;</span><br><span class="line">      yield [tok, line, false];</span><br><span class="line">      if (tok === &#x27;\n&#x27;) &#123; line++; col = 0; &#125;</span><br><span class="line">      else col++;</span><br><span class="line">      idx += tok.length;</span><br><span class="line">    &#125; else if (ch === &#x27;&quot;&#x27; || ch === &quot;&#x27;&quot;) &#123;</span><br><span class="line">      yield readString(ch);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      const tok = readToken();</span><br><span class="line">      if (tok) yield [tok, line, false];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ---------- util ----------</span><br><span class="line">class NgxParserDirectiveError extends Error &#123;</span><br><span class="line">  constructor(msg, lineno) &#123;</span><br><span class="line">    super(msg);</span><br><span class="line">    this.name = &#x27;NgxParserDirectiveError&#x27;;</span><br><span class="line">    this.lineno = lineno;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 简易版 analyze，只检查末尾符号</span><br><span class="line">function analyze(&#123; fname, stmt, term, ctx, strict, check_ctx, check_args &#125;) &#123;</span><br><span class="line">  const dir = stmt.directive;</span><br><span class="line">  if (dir === &#x27;#&#x27;) return;          // 注释跳过</span><br><span class="line">  if (dir.startsWith(&#x27;#&#x27;)) return;  // 行内注释也跳过</span><br><span class="line">  // 更复杂的上下文/参数检查可在此扩展</span><br><span class="line">  if (term !== &#x27;;&#x27; &amp;&amp; term !== &#x27;&#123;&#x27; &amp;&amp; term !== &#x27;&#125;&#x27;) &#123;</span><br><span class="line">    throw new NgxParserDirectiveError(</span><br><span class="line">      `directive &quot;$&#123;dir&#125;&quot; is not terminated by &quot;;&quot; or &quot;&#123;&quot;`, stmt.line);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function enterBlockCtx(stmt, ctx) &#123;</span><br><span class="line">  // 返回新的上下文，简单拼路径</span><br><span class="line">  return [...ctx, stmt.directive];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ---------- parser ----------</span><br><span class="line">export function parseNginx(text, &#123;</span><br><span class="line">  filename = &#x27;nginx.conf&#x27;,</span><br><span class="line">  onerror = null,</span><br><span class="line">  catchErrors = true,</span><br><span class="line">  ignore = [],</span><br><span class="line">  single = false,</span><br><span class="line">  comments = false,</span><br><span class="line">  strict = false,</span><br><span class="line">  checkCtx = true,</span><br><span class="line">  checkArgs = true</span><br><span class="line">&#125; = &#123;&#125;) &#123;</span><br><span class="line">  const tokens = [...lex(text, filename)]; // 先全部展开，方便 next()</span><br><span class="line">  let tokIdx = 0;</span><br><span class="line">  function next() &#123;</span><br><span class="line">    if (tokIdx &gt;= tokens.length) return [null, -1, false];</span><br><span class="line">    return tokens[tokIdx++];</span><br><span class="line">  &#125;</span><br><span class="line">  function peek() &#123;</span><br><span class="line">    if (tokIdx &gt;= tokens.length) return [null, -1, false];</span><br><span class="line">    return tokens[tokIdx];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const payload = &#123;</span><br><span class="line">    status: &#x27;ok&#x27;,</span><br><span class="line">    errors: [],</span><br><span class="line">    config: []</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  function handleError(parsing, e) &#123;</span><br><span class="line">    const file = parsing.file;</span><br><span class="line">    const errObj = &#123; file, error: e.message, line: e.lineno || null &#125;;</span><br><span class="line">    if (onerror) errObj.callback = onerror(e);</span><br><span class="line"></span><br><span class="line">    parsing.status = &#x27;failed&#x27;;</span><br><span class="line">    parsing.errors.push(&#123; error: e.message, line: e.lineno || null &#125;);</span><br><span class="line"></span><br><span class="line">    payload.status = &#x27;failed&#x27;;</span><br><span class="line">    payload.errors.push(errObj);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function _parse(parsing, ctx = [], consume = false) &#123;</span><br><span class="line">    const fname = parsing.file;</span><br><span class="line">    const parsed = [];</span><br><span class="line"></span><br><span class="line">    while (true) &#123;</span><br><span class="line">      const [token, lineno, quoted] = next();</span><br><span class="line">      if (!token) break;</span><br><span class="line">      if (token === &#x27;&#125;&#x27; &amp;&amp; !quoted) break;</span><br><span class="line">      if (consume) &#123;</span><br><span class="line">        if (token === &#x27;&#123;&#x27; &amp;&amp; !quoted) _parse(parsing, ctx, true);</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      const directive = token;</span><br><span class="line"></span><br><span class="line">      // 注释行</span><br><span class="line">      if (directive.startsWith(&#x27;#&#x27;) &amp;&amp; !quoted) &#123;</span><br><span class="line">        if (comments) &#123;</span><br><span class="line">          parsed.push(&#123; directive: &#x27;#&#x27;, line: lineno, args: [], comment: directive.slice(1).trim() &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      const stmt = &#123; directive, line: lineno, args: [] &#125;;</span><br><span class="line">      if (!single) stmt.file = fname;</span><br><span class="line"></span><br><span class="line">      // 收集参数</span><br><span class="line">      const commentsInArgs = [];</span><br><span class="line">      let term;</span><br><span class="line">      while (true) &#123;</span><br><span class="line">        const [t, , q] = peek();</span><br><span class="line">        if (!t || (!q &amp;&amp; [&#x27;;&#x27;, &#x27;&#123;&#x27;, &#x27;&#125;&#x27;].includes(t))) &#123; term = t; next(); break; &#125;</span><br><span class="line">        next();</span><br><span class="line">        if (t.startsWith(&#x27;#&#x27;) &amp;&amp; !q) commentsInArgs.push(t.slice(1).trim());</span><br><span class="line">        else stmt.args.push(t);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (ignore.includes(stmt.directive)) &#123;</span><br><span class="line">        if (term === &#x27;&#123;&#x27; &amp;&amp; !quoted) _parse(parsing, ctx, true);</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // if 特殊处理</span><br><span class="line">      if (stmt.directive === &#x27;if&#x27;) &#123;</span><br><span class="line">        const args = stmt.args;</span><br><span class="line">        if (args.length &amp;&amp; args[0].startsWith(&#x27;(&#x27;) &amp;&amp; args[args.length - 1].endsWith(&#x27;)&#x27;)) &#123;</span><br><span class="line">          args[0] = args[0].slice(1).trimLeft();</span><br><span class="line">          args[args.length - 1] = args[args.length - 1].slice(0, -1).trimRight();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">        analyze(&#123; fname, stmt, term, ctx, strict, check_ctx: checkCtx, check_args: checkArgs &#125;);</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        if (catchErrors) &#123;</span><br><span class="line">          handleError(parsing, e);</span><br><span class="line">          if (e.message.includes(&#x27;is not terminated&#x27;) &amp;&amp; term !== &#x27;&#125;&#x27; &amp;&amp; !quoted) &#123;</span><br><span class="line">            _parse(parsing, ctx, true);</span><br><span class="line">          &#125;</span><br><span class="line">          continue;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          throw e;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // include 处理（浏览器端不做文件 IO，只留空壳）</span><br><span class="line">      if (!single &amp;&amp; stmt.directive === &#x27;include&#x27;) &#123;</span><br><span class="line">        stmt.includes = [];   // 实际文件列表无法获取，留空</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (term === &#x27;&#123;&#x27; &amp;&amp; !quoted) &#123;</span><br><span class="line">        const inner = enterBlockCtx(stmt, ctx);</span><br><span class="line">        stmt.block = _parse(parsing, inner);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      parsed.push(stmt);</span><br><span class="line"></span><br><span class="line">      // 行内注释追加</span><br><span class="line">      commentsInArgs.forEach(c =&gt; parsed.push(&#123; directive: &#x27;#&#x27;, line: stmt.line, args: [], comment: c &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    return parsed;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 主流程</span><br><span class="line">  const parsing = &#123; file: filename, status: &#x27;ok&#x27;, errors: [], parsed: [] &#125;;</span><br><span class="line">  try &#123;</span><br><span class="line">    parsing.parsed = _parse(parsing, []);</span><br><span class="line">  &#125; catch (e) &#123;</span><br><span class="line">    handleError(parsing, e);</span><br><span class="line">  &#125;</span><br><span class="line">  payload.config.push(parsing);</span><br><span class="line">  return payload;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 预留外部解析器注册</span><br><span class="line">export function registerExternalParser(parser, directives) &#123;</span><br><span class="line">  directives.forEach(d =&gt; &#123; EXTERNAL_PARSERS[d] = parser; &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">a.html</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot; /&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;script type=&quot;module&quot;&gt;</span><br><span class="line">      import &#123; parseNginx &#125; from &quot;./nginx-parser.js&quot;;</span><br><span class="line"></span><br><span class="line">      const conf = `</span><br><span class="line">      user  nginx;</span><br><span class="line">      worker_processes  auto;</span><br><span class="line">      </span><br><span class="line">      events &#123;</span><br><span class="line">          worker_connections  1024;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      http &#123;</span><br><span class="line">          include       mime.types;</span><br><span class="line">          default_type  application/octet-stream;</span><br><span class="line">      </span><br><span class="line">          server &#123;</span><br><span class="line">              listen 80;</span><br><span class="line">              location / &#123;</span><br><span class="line">                  root /usr/share/nginx/html;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      `;</span><br><span class="line"></span><br><span class="line">      const payload = parseNginx(conf, &#123; comments: true &#125;);</span><br><span class="line">      console.log(JSON.stringify(payload, null, 2));</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">nginx-builder.js</span><br><span class="line"></span><br><span class="line">// nginx config builder (browser version)</span><br><span class="line">// 用法：</span><br><span class="line">//   import &#123; build, buildFiles &#125; from &#x27;./nginx-builder.js&#x27;;</span><br><span class="line">//   const txt = build(payload, &#123; indent:4, tabs:false, header:true &#125;);</span><br><span class="line"></span><br><span class="line">const EXTERNAL_BUILDERS = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">// 与 Python 版行为完全一致的转义检测</span><br><span class="line">function* _escape(string) &#123;</span><br><span class="line">  let prev = &#x27;&#x27;, char = &#x27;&#x27;;</span><br><span class="line">  for (let i = 0; i &lt; string.length; i++) &#123;</span><br><span class="line">    char = string[i];</span><br><span class="line">    if (prev === &#x27;\\&#x27; || prev + char === &#x27;$&#123;&#x27;) &#123;</span><br><span class="line">      prev += char;</span><br><span class="line">      yield prev;</span><br><span class="line">      prev = &#x27;&#x27;;</span><br><span class="line">      continue;</span><br><span class="line">    &#125;</span><br><span class="line">    if (prev === &#x27;$&#x27;) yield prev;</span><br><span class="line">    if (char !== &#x27;\\&#x27; &amp;&amp; char !== &#x27;$&#x27;) yield char;</span><br><span class="line">    prev = char;</span><br><span class="line">  &#125;</span><br><span class="line">  if (char === &#x27;\\&#x27; || char === &#x27;$&#x27;) yield char;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _needsQuotes(str) &#123;</span><br><span class="line">  if (str === &#x27;&#x27;) return true;</span><br><span class="line">  const gen = _escape(str);</span><br><span class="line">  // 首字符</span><br><span class="line">  let &#123; value: char, done &#125; = gen.next();</span><br><span class="line">  if (done) return false;</span><br><span class="line">  if (/\s/.test(char) || [&#x27;&#123;&#x27;, &#x27;&#125;&#x27;, &#x27;;&#x27;, &#x27;&quot;&#x27;, &quot;&#x27;&quot;, &#x27;$&#123;&#x27;].includes(char)) return true;</span><br><span class="line"></span><br><span class="line">  let expanding = false;</span><br><span class="line">  for (const ch of gen) &#123;</span><br><span class="line">    if (/\s/.test(ch) || [&#x27;&#123;&#x27;, &#x27;;&#x27;, &#x27;&quot;&#x27;, &quot;&#x27;&quot;].includes(ch)) return true;</span><br><span class="line">    if (ch === (expanding ? &#x27;&#125;&#x27; : &#x27;$&#123;&#x27;)) expanding = !expanding;</span><br><span class="line">  &#125;</span><br><span class="line">  return expanding;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 把字符串转成 nginx 可识别的带引号格式</span><br><span class="line">function _enquote(arg) &#123;</span><br><span class="line">  if (arg == null) return &#x27;&quot;&quot;&#x27;;          // 新增：空参数直接给 &quot;&quot;</span><br><span class="line">  if (!_needsQuotes(arg)) return arg;</span><br><span class="line">  // 浏览器里 repr 等价 JSON.stringify 后去头尾引号再自己加</span><br><span class="line">  let s = JSON.stringify(arg);</span><br><span class="line">  // JSON 会把 \ 变成 \\，我们需要单 \</span><br><span class="line">  s = s.replace(/\\\\/g, &#x27;\\&#x27;);</span><br><span class="line">  // 再包一层引号</span><br><span class="line">  return `&quot;$&#123;s.slice(1, -1)&#125;&quot;`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 将 payload 构建成字符串</span><br><span class="line"> * @param &#123;Array&#125; payload  对应 python 里的 parsed 数组</span><br><span class="line"> * @param &#123;Object&#125; opts</span><br><span class="line"> *        indent:number     缩进空格数</span><br><span class="line"> *        tabs:boolean      用 tab 代替空格</span><br><span class="line"> *        header:boolean    是否带生成头注释</span><br><span class="line"> * @returns &#123;string&#125;  nginx 文本</span><br><span class="line"> */</span><br><span class="line">export function build(payload, &#123; indent = 4, tabs = false, header = false &#125; = &#123;&#125;) &#123;</span><br><span class="line">  const padChar = tabs ? &#x27;\t&#x27; : &#x27; &#x27;;</span><br><span class="line">  const padding = (d) =&gt; padChar.repeat(tabs ? d : d * indent);</span><br><span class="line"></span><br><span class="line">  let head = &#x27;&#x27;;</span><br><span class="line">  if (header) &#123;</span><br><span class="line">    head += &#x27;# This config was built from JSON using NGINX crossplane.\n&#x27;;</span><br><span class="line">    head += &#x27;# If you encounter any bugs please report them here:\n&#x27;;</span><br><span class="line">    head += &#x27;# https://github.com/nginxinc/crossplane/issues\n\n&#x27;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function _buildBlock(block, depth, lastLine) &#123;</span><br><span class="line">    let out = &#x27;&#x27;;</span><br><span class="line">    const margin = padding(depth);</span><br><span class="line"></span><br><span class="line">    for (const stmt of block) &#123;</span><br><span class="line">      const dir = _enquote(stmt.directive ?? stmt.cmd ?? &#x27;&#x27;);</span><br><span class="line">      const line = stmt.line || 0;</span><br><span class="line"></span><br><span class="line">      // 行尾注释合并</span><br><span class="line">      if (dir === &#x27;#&#x27; &amp;&amp; line === lastLine) &#123;</span><br><span class="line">        out += &#x27; #&#x27; + stmt.comment;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line">      if (dir === &#x27;#&#x27;) &#123;</span><br><span class="line">        out += (out ? &#x27;\n&#x27; : &#x27;&#x27;) + margin + &#x27;#&#x27; + stmt.comment;</span><br><span class="line">        lastLine = line;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 外部自定义构造器</span><br><span class="line">      if (EXTERNAL_BUILDERS[dir]) &#123;</span><br><span class="line">        out += (out ? &#x27;\n&#x27; : &#x27;&#x27;) + margin + EXTERNAL_BUILDERS[dir](stmt, padding, indent, tabs);</span><br><span class="line">        lastLine = line;</span><br><span class="line">        continue;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // 普通指令</span><br><span class="line">      const args = (stmt.args ?? stmt.arguments ?? []).map(_enquote);</span><br><span class="line">      let built;</span><br><span class="line">      if (dir === &#x27;if&#x27;) &#123;</span><br><span class="line">        built = `if ($&#123;args.join(&#x27; &#x27;)&#125;)`;</span><br><span class="line">      &#125; else if (args.length) &#123;</span><br><span class="line">        built = `$&#123;dir&#125; $&#123;args.join(&#x27; &#x27;)&#125;`;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        built = dir;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (stmt.block == null) &#123;</span><br><span class="line">        built += &#x27;;&#x27;;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        built += &#x27; &#123;&#x27;;</span><br><span class="line">        const inner = _buildBlock(stmt.block, depth + 1, line);</span><br><span class="line">        built += inner + &#x27;\n&#x27; + margin + &#x27;&#125;&#x27;;</span><br><span class="line">      &#125;</span><br><span class="line">      out += (out ? &#x27;\n&#x27; : &#x27;&#x27;) + margin + built;</span><br><span class="line">      lastLine = line;</span><br><span class="line">    &#125;</span><br><span class="line">    return out;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const body = _buildBlock(payload, 0, 0);</span><br><span class="line">  return head + body;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 为浏览器准备的“写盘”封装：返回 filename =&gt; content 的 Map</span><br><span class="line"> * @param &#123;Object&#125; payload   crossplane.parse 的完整输出</span><br><span class="line"> * @param &#123;Object&#125; opts      同 build 函数</span><br><span class="line"> * @returns &#123;Map&#125;            key=绝对路径，value=文本</span><br><span class="line"> */</span><br><span class="line">export function buildFiles(payload, &#123; indent = 4, tabs = false, header = false &#125; = &#123;&#125;) &#123;</span><br><span class="line">  const map = new Map();</span><br><span class="line">  for (const config of payload.config) &#123;</span><br><span class="line">    const content = build(config.parsed, &#123; indent, tabs, header &#125;);</span><br><span class="line">    map.set(config.file, content.replace(/\n+$/, &#x27;\n&#x27;)); // 保证末尾一个换行</span><br><span class="line">  &#125;</span><br><span class="line">  return map;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 注册第三方构造器</span><br><span class="line"> * @param &#123;Function&#125; builder     function(stmt, padding, indent, tabs)-&gt;string</span><br><span class="line"> * @param &#123;Array&lt;string&gt;&#125; dirs   指令列表</span><br><span class="line"> */</span><br><span class="line">export function registerExternalBuilder(builder, dirs) &#123;</span><br><span class="line">  dirs.forEach(d =&gt; &#123; EXTERNAL_BUILDERS[d] = builder; &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b.html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot; /&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;script type=&quot;module&quot;&gt;</span><br><span class="line">      import &#123; build, buildFiles &#125; from &quot;./nginx-builder.js&quot;;</span><br><span class="line"></span><br><span class="line">      const payload = &#123;</span><br><span class="line">        config: [</span><br><span class="line">          &#123;</span><br><span class="line">            file: &quot;/etc/nginx/nginx.conf&quot;,</span><br><span class="line">            parsed: [</span><br><span class="line">              &#123;</span><br><span class="line">                directive: &quot;user&quot;,</span><br><span class="line">                line: 2,</span><br><span class="line">                args: [&quot;nginx&quot;],</span><br><span class="line">                file: &quot;nginx.conf&quot;,</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                directive: &quot;worker_processes&quot;,</span><br><span class="line">                line: 3,</span><br><span class="line">                args: [&quot;auto&quot;],</span><br><span class="line">                file: &quot;nginx.conf&quot;,</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                directive: &quot;events&quot;,</span><br><span class="line">                line: 5,</span><br><span class="line">                args: [],</span><br><span class="line">                file: &quot;nginx.conf&quot;,</span><br><span class="line">                block: [</span><br><span class="line">                  &#123;</span><br><span class="line">                    directive: &quot;worker_connections&quot;,</span><br><span class="line">                    line: 6,</span><br><span class="line">                    args: [&quot;1024&quot;],</span><br><span class="line">                    file: &quot;nginx.conf&quot;,</span><br><span class="line">                  &#125;,</span><br><span class="line">                ],</span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                directive: &quot;http&quot;,</span><br><span class="line">                line: 9,</span><br><span class="line">                args: [],</span><br><span class="line">                file: &quot;nginx.conf&quot;,</span><br><span class="line">                block: [</span><br><span class="line">                  &#123;</span><br><span class="line">                    directive: &quot;include&quot;,</span><br><span class="line">                    line: 10,</span><br><span class="line">                    args: [&quot;mime.types&quot;],</span><br><span class="line">                    file: &quot;nginx.conf&quot;,</span><br><span class="line">                    includes: [],</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    directive: &quot;default_type&quot;,</span><br><span class="line">                    line: 11,</span><br><span class="line">                    args: [&quot;application/octet-stream&quot;],</span><br><span class="line">                    file: &quot;nginx.conf&quot;,</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    directive: &quot;server&quot;,</span><br><span class="line">                    line: 13,</span><br><span class="line">                    args: [],</span><br><span class="line">                    file: &quot;nginx.conf&quot;,</span><br><span class="line">                    block: [</span><br><span class="line">                      &#123;</span><br><span class="line">                        directive: &quot;listen&quot;,</span><br><span class="line">                        line: 14,</span><br><span class="line">                        args: [&quot;80&quot;],</span><br><span class="line">                        file: &quot;nginx.conf&quot;,</span><br><span class="line">                      &#125;,</span><br><span class="line">                      &#123;</span><br><span class="line">                        directive: &quot;location&quot;,</span><br><span class="line">                        line: 15,</span><br><span class="line">                        args: [&quot;/&quot;],</span><br><span class="line">                        file: &quot;nginx.conf&quot;,</span><br><span class="line">                        block: [</span><br><span class="line">                          &#123;</span><br><span class="line">                            directive: &quot;root&quot;,</span><br><span class="line">                            line: 16,</span><br><span class="line">                            args: [&quot;/usr/share/nginx/html&quot;],</span><br><span class="line">                            file: &quot;nginx.conf&quot;,</span><br><span class="line">                          &#125;,</span><br><span class="line">                        ],</span><br><span class="line">                      &#125;,</span><br><span class="line">                    ],</span><br><span class="line">                  &#125;,</span><br><span class="line">                ],</span><br><span class="line">              &#125;,</span><br><span class="line">            ],</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      // 1. 只拿文本</span><br><span class="line">      const txt = build(payload.config[0].parsed, &#123; header: true &#125;);</span><br><span class="line">      console.log(txt);</span><br><span class="line"></span><br><span class="line">      // 2. 拿全部文件</span><br><span class="line">      const fileMap = buildFiles(payload);</span><br><span class="line">      for (const [name, content] of fileMap) &#123;</span><br><span class="line">        console.log(&quot;===&quot;, name, &quot;===&quot;);</span><br><span class="line">        console.log(content);</span><br><span class="line">      &#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/10/23/%E6%8A%93%E5%8C%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangzhiwei">
      <meta itemprop="description" content="javascript nodejs web developer...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/10/23/%E6%8A%93%E5%8C%85/" class="post-title-link" itemprop="url">抓9000 端口 上的请求</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-10-23 17:03:14" itemprop="dateCreated datePublished" datetime="2025-10-23T17:03:14+08:00">2025-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-12-10 17:09:56" itemprop="dateModified" datetime="2025-12-10T17:09:56+08:00">2025-12-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%93%E5%8C%85/" itemprop="url" rel="index"><span itemprop="name">抓包</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>192.168.40.116 机器上</p>
<p>ip a</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:94:5c:7f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.40.116/24 brd 192.168.40.255 scope global noprefixroute ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 172.17.10.10/24 scope global ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 2408:8606:8400:30a:6::41/128 scope global noprefixroute dynamic</span><br><span class="line">       valid_lft 6018sec preferred_lft 5718sec</span><br><span class="line">    inet6 fe80::d6f6:f5f6:1e6c:cf29/64 scope link noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    link/ether 52:54:00:26:ce:e5 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ens192 为默认网卡</p>
<p>sudo tcpdump ‘port 9000’ -w a.cap -i ens192</p>
<p>监听 9000 端口 上的请求，指定 网卡 为 ens192 并将其保存到 a.cap 文件中</p>
<p>下载 a.cap 文件</p>
<p>将其 拉入到 wireshark 进行分析</p>
<p>sudo ln -s &#x2F;Applications&#x2F;Wireshark.app&#x2F;Contents&#x2F;MacOS&#x2F;Wireshark &#x2F;usr&#x2F;local&#x2F;bin&#x2F;wireshark</p>
<p>wireshark a.cap</p>
<p>也可以将 a.cap 文件拉入到 wireshark 中进行查看</p>
<p><img src="/../images/wireshark/01.png"></p>
<p><img src="/../images/wireshark/02.png"></p>
<p>sudo tcpdump ‘port 18080’ -w 73_3.cap -i any</p>
<p>scp <a href="mailto:&#x61;&#x64;&#x6d;&#x69;&#110;&#64;&#x31;&#57;&#50;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#52;&#x30;&#46;&#55;&#51;">&#x61;&#x64;&#x6d;&#x69;&#110;&#64;&#x31;&#57;&#50;&#x2e;&#x31;&#x36;&#x38;&#x2e;&#52;&#x30;&#46;&#55;&#51;</a>:&#x2F;home&#x2F;admin&#x2F;73_3.cap .&#x2F;</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/08/13/sekiro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangzhiwei">
      <meta itemprop="description" content="javascript nodejs web developer...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/08/13/sekiro/" class="post-title-link" itemprop="url">sekiro - js逆向</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-08-13 15:47:06" itemprop="dateCreated datePublished" datetime="2025-08-13T15:47:06+08:00">2025-08-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-10-23 17:02:14" itemprop="dateModified" datetime="2025-10-23T17:02:14+08:00">2025-10-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>安装：sekiro</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">docker run -d --name sekiro -p 5612:5612 \</span><br><span class="line">  registry.cn-beijing.aliyuncs.com/iinti/common:sekiro-all-in-one-latest</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>浏览器中登录：<br><a target="_blank" rel="noopener" href="http://127.0.0.1:5612/#/">http://127.0.0.1:5612/#/</a></p>
<p>打开某网页，在浏览器 console 中输入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">function SekiroClient(e)&#123;if(this.wsURL=e,this.handlers=&#123;&#125;,this.socket=&#123;&#125;,!e)throw new Error(&quot;wsURL can not be empty!!&quot;);this.webSocketFactory=this.resolveWebSocketFactory(),this.connect()&#125;SekiroClient.prototype.resolveWebSocketFactory=function()&#123;if(&quot;object&quot;==typeof window)&#123;var e=window.WebSocket?window.WebSocket:window.MozWebSocket;return function(o)&#123;function t(o)&#123;this.mSocket=new e(o)&#125;return t.prototype.close=function()&#123;this.mSocket.close()&#125;,t.prototype.onmessage=function(e)&#123;this.mSocket.onmessage=e&#125;,t.prototype.onopen=function(e)&#123;this.mSocket.onopen=e&#125;,t.prototype.onclose=function(e)&#123;this.mSocket.onclose=e&#125;,t.prototype.send=function(e)&#123;this.mSocket.send(e)&#125;,new t(o)&#125;&#125;if(&quot;object&quot;==typeof weex)try&#123;console.log(&quot;test webSocket for weex&quot;);var o=weex.requireModule(&quot;webSocket&quot;);return console.log(&quot;find webSocket for weex:&quot;+o),function(e)&#123;try&#123;o.close()&#125;catch(e)&#123;&#125;return o.WebSocket(e,&quot;&quot;),o&#125;&#125;catch(e)&#123;console.log(e)&#125;if(&quot;object&quot;==typeof WebSocket)return function(o)&#123;return new e(o)&#125;;throw new Error(&quot;the js environment do not support websocket&quot;)&#125;,SekiroClient.prototype.connect=function()&#123;console.log(&quot;sekiro: begin of connect to wsURL: &quot;+this.wsURL);var e=this;try&#123;this.socket=this.webSocketFactory(this.wsURL)&#125;catch(o)&#123;return console.log(&quot;sekiro: create connection failed,reconnect after 2s:&quot;+o),void setTimeout(function()&#123;e.connect()&#125;,2e3)&#125;this.socket.onmessage(function(o)&#123;e.handleSekiroRequest(o.data)&#125;),this.socket.onopen(function(e)&#123;console.log(&quot;sekiro: open a sekiro client connection&quot;)&#125;),this.socket.onclose(function(o)&#123;console.log(&quot;sekiro: disconnected ,reconnection after 2s&quot;),setTimeout(function()&#123;e.connect()&#125;,2e3)&#125;)&#125;,SekiroClient.prototype.handleSekiroRequest=function(e)&#123;console.log(&quot;receive sekiro request: &quot;+e);var o=JSON.parse(e),t=o.__sekiro_seq__;if(o.action)&#123;var n=o.action;if(this.handlers[n])&#123;var s=this.handlers[n],i=this;try&#123;s(o,function(e)&#123;try&#123;i.sendSuccess(t,e)&#125;catch(e)&#123;i.sendFailed(t,&quot;e:&quot;+e)&#125;&#125;,function(e)&#123;i.sendFailed(t,e)&#125;)&#125;catch(e)&#123;console.log(&quot;error: &quot;+e),i.sendFailed(t,&quot;:&quot;+e)&#125;&#125;else this.sendFailed(t,&quot;no action handler: &quot;+n+&quot; defined&quot;)&#125;else this.sendFailed(t,&quot;need request param &#123;action&#125;&quot;)&#125;,SekiroClient.prototype.sendSuccess=function(e,o)&#123;var t;if(&quot;string&quot;==typeof o)try&#123;t=JSON.parse(o)&#125;catch(e)&#123;(t=&#123;&#125;).data=o&#125;else&quot;object&quot;==typeof o?t=o:(t=&#123;&#125;).data=o;(Array.isArray(t)||&quot;string&quot;==typeof t)&amp;&amp;(t=&#123;data:t,code:0&#125;),t.code?t.code=0:(t.status,t.status=0),t.__sekiro_seq__=e;var n=JSON.stringify(t);console.log(&quot;response :&quot;+n),this.socket.send(n)&#125;,SekiroClient.prototype.sendFailed=function(e,o)&#123;&quot;string&quot;!=typeof o&amp;&amp;(o=JSON.stringify(o));var t=&#123;&#125;;t.message=o,t.status=-1,t.__sekiro_seq__=e;var n=JSON.stringify(t);console.log(&quot;sekiro: response :&quot;+n),this.socket.send(n)&#125;,SekiroClient.prototype.registerAction=function(e,o)&#123;if(&quot;string&quot;!=typeof e)throw new Error(&quot;an action must be string&quot;);if(&quot;function&quot;!=typeof o)throw new Error(&quot;a handler must be function&quot;);return console.log(&quot;sekiro: register action: &quot;+e),this.handlers[e]=o,this&#125;;</span><br><span class="line">var client = new SekiroClient(&quot;ws://127.0.0.1:5612/business/register?group=testAction&amp;clientId=&quot; + Math.random());</span><br><span class="line">client.registerAction(&quot;testAction&quot;, function (request, resolve, reject) &#123;</span><br><span class="line"></span><br><span class="line">    resolve(Math.random());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>浏览器中打开：</p>
<p><a target="_blank" rel="noopener" href="http://localhost:5612/business/invoke?group=testAction&action=testAction&param=testparm">http://localhost:5612/business/invoke?group=testAction&amp;action=testAction&amp;param=testparm</a></p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://sekiro.iinti.cn/sekiro-doc/">https://sekiro.iinti.cn/sekiro-doc/</a><br>参考视频：<br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV16U4y1B7PA/?spm_id_from=333.1387.favlist.content.click&vd_source=ffda878df0ed45bee1ade91d8f451048">https://www.bilibili.com/video/BV16U4y1B7PA/?spm_id_from=333.1387.favlist.content.click&amp;vd_source=ffda878df0ed45bee1ade91d8f451048</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/08/07/vite-monorepo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangzhiwei">
      <meta itemprop="description" content="javascript nodejs web developer...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/08/07/vite-monorepo/" class="post-title-link" itemprop="url">vite+monorepo</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-08-07 17:54:52 / 修改时间：17:56:44" itemprop="dateCreated datePublished" datetime="2025-08-07T17:54:52+08:00">2025-08-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>混合项目结构，所有相关的工程形成子包进行管理<br>技术栈高度统一，(团队基建项目、业务项目、子服务，技术栈)规范化、自动化、流程化项目间共享<br>依赖管理，版本统-管理<br>部署，docker、docker compose，自动化脚本统-部署流程</p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1UePTeqEu6/?spm_id_from=333.1387.favlist.content.click">https://www.bilibili.com/video/BV1UePTeqEu6/?spm_id_from=333.1387.favlist.content.click</a><br><a target="_blank" rel="noopener" href="https://github.com/robcaldecott/pnpm-vite-monorepo-example">https://github.com/robcaldecott/pnpm-vite-monorepo-example</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/13/%E5%90%B4%E6%81%A9%E8%BE%BE%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangzhiwei">
      <meta itemprop="description" content="javascript nodejs web developer...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/13/%E5%90%B4%E6%81%A9%E8%BE%BE%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">吴恩达算法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-05-13 09:37:07" itemprop="dateCreated datePublished" datetime="2025-05-13T09:37:07+08:00">2025-05-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/10/tfjs-study6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangzhiwei">
      <meta itemprop="description" content="javascript nodejs web developer...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/10/tfjs-study6/" class="post-title-link" itemprop="url">tfjs-study6</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-05-10 15:31:07 / 修改时间：16:48:31" itemprop="dateCreated datePublished" datetime="2025-05-10T15:31:07+08:00">2025-05-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="python-与-javascript-互转"><a href="#python-与-javascript-互转" class="headerlink" title="python 与 javascript 互转"></a>python 与 javascript 互转</h2><p>python 模型：<br>通过 python 版 TensorFlow&#x2F;Keras 生成模型</p>
<p>包括： TensorFlow SavedModel、Keras HDF5 模型 等</p>
<p>获取：开源网站下载&#x2F;算法同事提供</p>
<p>javascript 模型：</p>
<p>可以在 TensorFlowJS中运行的模型</p>
<p>包括： tfjs_layers_model.json、tfjs_graph_model.json、tfjs_weights.bin 等</p>
<p>获取：开源网站下载&#x2F;通过TFJS生成&#x2F;由python 模型转换而来</p>
<p>为何要进行互转?<br>Python to JavaScript:JavaScript模型可以在浏览器中运行</p>
<p>JavaScript to Python:少见,为了在更多平台运行</p>
<p>JavaScript to JavaScript:分片&#x2F;量化&#x2F;加速</p>
<p>如何进行互转?<br>安装Tensorflow.js Converter<br>在命令行指定输入输出的路径和模型格式即可</p>
<p>操作步骤<br>安装Tensorflow.js Converter<br>Python与JavaScript模型互转<br>JavaScript模型的互转:分片、量化、加速</p>
<p>安装Tensorflow.js Converter</p>
<p>操作步骤<br>安装Conda<br>使用Conda安装Python虚拟环境<br>使用Python虚拟环境安装Tensorflow.jsConverter</p>
<p><img src="/../images/tfjs/69.png"></p>
<p><img src="/../images/tfjs/70.png"></p>
<p><img src="/../images/tfjs/71.png"></p>
<p><img src="/../images/tfjs/72.png"></p>
<p><img src="/../images/tfjs/73.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/10/tfjs-study5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangzhiwei">
      <meta itemprop="description" content="javascript nodejs web developer...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/05/10/tfjs-study5/" class="post-title-link" itemprop="url">tfjs-study5</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-05-10 14:23:22 / 修改时间：16:25:42" itemprop="dateCreated datePublished" datetime="2025-05-10T14:23:22+08:00">2025-05-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="使用预训练模型进行语音识别"><a href="#使用预训练模型进行语音识别" class="headerlink" title="使用预训练模型进行语音识别"></a>使用预训练模型进行语音识别</h2><p>模型接受声音信息，输出分类信息<br>声音在计算机里是声谱图，因此也可以使用卷积神经网络进行识别</p>
<p><img src="/../images/tfjs/65.png"></p>
<p><img src="/../images/tfjs/66.png"></p>
<p><img src="/../images/tfjs/67.png"></p>
<p><img src="/../images/tfjs/68.png"></p>
<p>script.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">import * as speechCommands from &#x27;@tensorflow-models/speech-commands&#x27;;</span><br><span class="line"></span><br><span class="line">const MODEL_PATH = &#x27;http://127.0.0.1:8080/speech&#x27;;</span><br><span class="line"></span><br><span class="line">window.onload = async () =&gt; &#123;</span><br><span class="line">    const recognizer = speechCommands.create(</span><br><span class="line">        &#x27;BROWSER_FFT&#x27;,</span><br><span class="line">        null,</span><br><span class="line">        MODEL_PATH + &#x27;/model.json&#x27;,</span><br><span class="line">        MODEL_PATH + &#x27;/metadata.json&#x27;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    await recognizer.ensureModelLoaded();</span><br><span class="line"></span><br><span class="line">    const labels = recognizer.wordLabels().slice(2); //</span><br><span class="line">    const resultEl = document.querySelector(&#x27;#result&#x27;);</span><br><span class="line">    resultEl.innerHTML = labels.map(l =&gt; `</span><br><span class="line">        &lt;div&gt;$&#123;l&#125;&lt;/div&gt;</span><br><span class="line">    `).join(&#x27;&#x27;);</span><br><span class="line">    recognizer.listen(result =&gt; &#123; //会打开浏览器麦克风</span><br><span class="line">        const &#123; scores &#125; = result;</span><br><span class="line">        const maxValue = Math.max(...scores);</span><br><span class="line">        const index = scores.indexOf(maxValue) - 2;</span><br><span class="line">        resultEl.innerHTML = labels.map((l, i) =&gt; `</span><br><span class="line">        &lt;div style=&quot;background: $&#123;i === index &amp;&amp; &#x27;green&#x27;&#125;&quot;&gt;$&#123;l&#125;&lt;/div&gt;</span><br><span class="line">        `).join(&#x27;&#x27;);</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        overlapFactor: 0.3, //重叠</span><br><span class="line">        probabilityThreshold: 0.9 // 置信度</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<p>index.html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;script src=&quot;script.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    #result&gt;div &#123;</span><br><span class="line">        float: left;</span><br><span class="line">        padding: 20px;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;div id=&quot;result&quot;&gt;&lt;/div&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="基于迁移学习的语音识别器：声控轮播图"><a href="#基于迁移学习的语音识别器：声控轮播图" class="headerlink" title="基于迁移学习的语音识别器：声控轮播图"></a>基于迁移学习的语音识别器：声控轮播图</h2><p>在浏览器中收集中文语音训练数据</p>
<p>使用 speech commands （英文语音识别） 包进行迁移学习并预测 中文语音</p>
<p>语音训练数据的保存和加载</p>
<p>操作步骤</p>
<p>使用 speech commands 包创建迁移学习器<br>编写前端界面准备收集语音数据<br>调用collectExample函数收集语音数据</p>
<p><img src="/../images/tfjs/68.png"></p>
<p>index.html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;script.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;button onclick=&quot;collect(this)&quot;&gt;上一张&lt;/button&gt;</span><br><span class="line">&lt;button onclick=&quot;collect(this)&quot;&gt;下一张&lt;/button&gt;</span><br><span class="line">&lt;button onclick=&quot;collect(this)&quot;&gt;背景噪音&lt;/button&gt;</span><br><span class="line">&lt;button onclick=&quot;save()&quot;&gt;保存&lt;/button&gt;</span><br><span class="line">&lt;pre id=&quot;count&quot;&gt;&lt;/pre&gt;</span><br><span class="line">&lt;button onclick=&quot;train()&quot;&gt;训练&lt;/button&gt;</span><br><span class="line">&lt;br&gt;&lt;br&gt;</span><br><span class="line">监听开关：&lt;input type=&quot;checkbox&quot; onchange=&quot;toggle(this.checked)&quot;&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>script.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">import * as speechCommands from &#x27;@tensorflow-models/speech-commands&#x27;;</span><br><span class="line">import * as tfvis from &#x27;@tensorflow/tfjs-vis&#x27;;</span><br><span class="line"></span><br><span class="line">const MODEL_PATH = &#x27;http://127.0.0.1:8080&#x27;;</span><br><span class="line">let transferRecognizer;</span><br><span class="line"></span><br><span class="line">window.onload = async () =&gt; &#123;</span><br><span class="line">    const recognizer = speechCommands.create(</span><br><span class="line">        &#x27;BROWSER_FFT&#x27;,</span><br><span class="line">        null,</span><br><span class="line">        MODEL_PATH + &#x27;/speech/model.json&#x27;,</span><br><span class="line">        MODEL_PATH + &#x27;/speech/metadata.json&#x27;</span><br><span class="line">    );</span><br><span class="line">    await recognizer.ensureModelLoaded(); // 加载模型</span><br><span class="line">    transferRecognizer = recognizer.createTransfer(&#x27;轮播图&#x27;); // 创建一个训练器</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">window.collect = async (btn) =&gt; &#123;</span><br><span class="line">    btn.disabled = true;</span><br><span class="line">    const label = btn.innerText;</span><br><span class="line">    await transferRecognizer.collectExample( //  收集样本</span><br><span class="line">        label === &#x27;背景噪音&#x27; ? &#x27;_background_noise_&#x27; : label</span><br><span class="line">    );</span><br><span class="line">    btn.disabled = false;</span><br><span class="line">    document.querySelector(&#x27;#count&#x27;).innerHTML = JSON.stringify(transferRecognizer.countExamples(), null, 2);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">window.train = async () =&gt; &#123;</span><br><span class="line">    await transferRecognizer.train(&#123;</span><br><span class="line">        epochs: 30,</span><br><span class="line">        callback: tfvis.show.fitCallbacks(</span><br><span class="line">            &#123; name: &#x27;训练效果&#x27; &#125;,</span><br><span class="line">            [&#x27;loss&#x27;, &#x27;acc&#x27;],</span><br><span class="line">            &#123; callbacks: [&#x27;onEpochEnd&#x27;] &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">window.toggle = async (checked) =&gt; &#123;</span><br><span class="line">    if (checked) &#123;</span><br><span class="line">        await transferRecognizer.listen(result =&gt; &#123; // 监听</span><br><span class="line">            const &#123; scores &#125; = result;</span><br><span class="line">            const labels = transferRecognizer.wordLabels();</span><br><span class="line">            const index = scores.indexOf(Math.max(...scores));</span><br><span class="line">            console.log(labels[index]);</span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            overlapFactor: 0,</span><br><span class="line">            probabilityThreshold: 0.75</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        transferRecognizer.stopListening();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">window.save = () =&gt; &#123;</span><br><span class="line">    const arrayBuffer = transferRecognizer.serializeExamples(); //把采集好的数据存下来</span><br><span class="line">    const blob = new Blob([arrayBuffer]);</span><br><span class="line">    const link = document.createElement(&#x27;a&#x27;);</span><br><span class="line">    link.href = window.URL.createObjectURL(blob);</span><br><span class="line">    link.download = &#x27;data.bin&#x27;;</span><br><span class="line">    link.click();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="轮播图"><a href="#轮播图" class="headerlink" title="轮播图"></a>轮播图</h2><p>index.html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;script.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">监听开关：&lt;input type=&quot;checkbox&quot; onchange=&quot;toggle(this.checked)&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">    .slider &#123;</span><br><span class="line">        width: 600px;</span><br><span class="line">        overflow: hidden;</span><br><span class="line">        margin: 10px auto;</span><br><span class="line">    &#125;</span><br><span class="line">    .slider &gt; div&#123;</span><br><span class="line">        display: flex;</span><br><span class="line">        align-items: center;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;div class=&quot;slider&quot;&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;img src=&quot;https://cdn.pixabay.com/photo/2019/10/29/15/57/vancouver-4587302__480.jpg&quot; alt=&quot;&quot; width=&quot;600&quot;&gt;</span><br><span class="line">        &lt;img src=&quot;https://cdn.pixabay.com/photo/2019/10/31/07/14/coffee-4591159__480.jpg&quot; alt=&quot;&quot; width=&quot;600&quot;&gt;</span><br><span class="line">        &lt;img src=&quot;https://cdn.pixabay.com/photo/2019/11/01/11/08/landscape-4593909__480.jpg&quot; alt=&quot;&quot; width=&quot;600&quot;&gt;</span><br><span class="line">        &lt;img src=&quot;https://cdn.pixabay.com/photo/2019/11/02/21/45/maple-leaf-4597501__480.jpg&quot; alt=&quot;&quot; width=&quot;600&quot;&gt;</span><br><span class="line">        &lt;img src=&quot;https://cdn.pixabay.com/photo/2019/11/02/03/13/in-xinjiang-4595560__480.jpg&quot; alt=&quot;&quot; width=&quot;600&quot;&gt;</span><br><span class="line">        &lt;img src=&quot;https://cdn.pixabay.com/photo/2019/11/01/22/45/reschensee-4595385__480.jpg&quot; alt=&quot;&quot; width=&quot;600&quot;&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>script.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">import * as speechCommands from &#x27;@tensorflow-models/speech-commands&#x27;;</span><br><span class="line"></span><br><span class="line">const MODEL_PATH = &#x27;http://127.0.0.1:8080&#x27;;</span><br><span class="line">let transferRecognizer;</span><br><span class="line">let curIndex = 0;</span><br><span class="line"></span><br><span class="line">window.onload = async () =&gt; &#123;</span><br><span class="line">    const recognizer = speechCommands.create(</span><br><span class="line">        &#x27;BROWSER_FFT&#x27;,</span><br><span class="line">        null,</span><br><span class="line">        MODEL_PATH + &#x27;/speech/model.json&#x27;,</span><br><span class="line">        MODEL_PATH + &#x27;/speech/metadata.json&#x27;,</span><br><span class="line">    );</span><br><span class="line">    await recognizer.ensureModelLoaded();</span><br><span class="line">    transferRecognizer = recognizer.createTransfer(&#x27;轮播图&#x27;);</span><br><span class="line">    const res = await fetch(MODEL_PATH + &#x27;/slider/data.bin&#x27;);</span><br><span class="line">    const arrayBuffer = await res.arrayBuffer();</span><br><span class="line">    transferRecognizer.loadExamples(arrayBuffer);</span><br><span class="line">    await transferRecognizer.train(&#123; epochs: 30 &#125;);</span><br><span class="line">    console.log(&#x27;done&#x27;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">window.toggle = async (checked) =&gt; &#123;</span><br><span class="line">    if (checked) &#123;</span><br><span class="line">        await transferRecognizer.listen(result =&gt; &#123;</span><br><span class="line">            const &#123; scores &#125; = result;</span><br><span class="line">            const labels = transferRecognizer.wordLabels();</span><br><span class="line">            const index = scores.indexOf(Math.max(...scores));</span><br><span class="line">            window.play(labels[index]);</span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            overlapFactor: 0,</span><br><span class="line">            probabilityThreshold: 0.5</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        transferRecognizer.stopListening();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">window.play = (label) =&gt; &#123;</span><br><span class="line">    const div = document.querySelector(&#x27;.slider&gt;div&#x27;);</span><br><span class="line">    if (label === &#x27;上一张&#x27;) &#123;</span><br><span class="line">        if (curIndex === 0) &#123; return; &#125;</span><br><span class="line">        curIndex -= 1;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (curIndex === document.querySelectorAll(&#x27;img&#x27;).length - 1) &#123; return; &#125;</span><br><span class="line">        curIndex += 1;</span><br><span class="line">    &#125;</span><br><span class="line">    div.style.transition = &quot;transform 1s&quot;</span><br><span class="line">    div.style.transform = `translateX(-$&#123;100 * curIndex&#125;%)`;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">wangzhiwei</p>
  <div class="site-description" itemprop="description">javascript nodejs web developer...</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">93</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">57</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wangzhiwei</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
