<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="快速开始环境处理clone 项目执行 make 命令生成 qjs qjsc 命令行工具  可以执行 系统命令 12345678910111213141516171819202122232425262728293031import &#123; popen &#125; from &#x27;std&#x27;;import * as os from &quot;os&quot;;import *">
<meta property="og:type" content="article">
<meta property="og:title" content="quickjs">
<meta property="og:url" content="http://example.com/2024/12/13/quickjs/index.html">
<meta property="og:site_name" content="WBlog">
<meta property="og:description" content="快速开始环境处理clone 项目执行 make 命令生成 qjs qjsc 命令行工具  可以执行 系统命令 12345678910111213141516171819202122232425262728293031import &#123; popen &#125; from &#x27;std&#x27;;import * as os from &quot;os&quot;;import *">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/quickjs_01.png">
<meta property="og:image" content="http://example.com/images/quickjs_02.png">
<meta property="article:published_time" content="2024-12-13T06:52:42.000Z">
<meta property="article:modified_time" content="2025-03-18T03:10:52.053Z">
<meta property="article:author" content="wangzhiwei">
<meta property="article:tag" content="nginx njs quickjs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/quickjs_01.png">

<link rel="canonical" href="http://example.com/2024/12/13/quickjs/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>quickjs | WBlog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">WBlog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">wangzhiwei blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/12/13/quickjs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="wangzhiwei">
      <meta itemprop="description" content="javascript nodejs web developer...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WBlog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          quickjs
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-12-13 14:52:42" itemprop="dateCreated datePublished" datetime="2024-12-13T14:52:42+08:00">2024-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-18 11:10:52" itemprop="dateModified" datetime="2025-03-18T11:10:52+08:00">2025-03-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index"><span itemprop="name">nginx</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h1><p>环境处理<br>clone 项目<br>执行 make 命令<br>生成 qjs qjsc 命令行工具 </p>
<p>可以执行 系统命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import &#123; popen &#125; from &#x27;std&#x27;;</span><br><span class="line"></span><br><span class="line">import * as os from &quot;os&quot;;</span><br><span class="line">import * as std from &quot;std&quot;;</span><br><span class="line"></span><br><span class="line">var errorObj = &#123;&#125;;</span><br><span class="line">// var pipe = popen(&quot;./examples/hello&quot;, &quot;r&quot;, errorObj);</span><br><span class="line">var pipe = popen(&quot;ls -la&quot;, &quot;r&quot;, errorObj);</span><br><span class="line">if (!pipe) &#123;</span><br><span class="line">    throw new Error(`Failed to open pipe: $&#123;errorObj.errno&#125;`);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.log(pipe.readAsString())</span><br><span class="line">// var output = readAll(pipe);</span><br><span class="line">// console.log(output.toString());</span><br><span class="line">// pipe.close();</span><br><span class="line"></span><br><span class="line">var ret = os.exec([&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;exit 1&quot;], &#123; usePath: false &#125;);</span><br><span class="line"></span><br><span class="line">console.log(ret)</span><br><span class="line"></span><br><span class="line">var f = std.tmpfile();</span><br><span class="line">var str = &quot;hello world\n&quot;;</span><br><span class="line">f.puts(str);</span><br><span class="line"></span><br><span class="line">f.seek(0, std.SEEK_SET);</span><br><span class="line">var str1 = f.readAsString();</span><br><span class="line">// assert(str1 === str);</span><br><span class="line"></span><br><span class="line">console.log(str1)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>自己通过 curl 命令封装 fetch 方法</p>
<p>quick 可以使用 redaxios - 调用远程请求<br><a target="_blank" rel="noopener" href="https://github.com/wangzhiwei1888/redaxios/tree/master">https://github.com/wangzhiwei1888/redaxios/tree/master</a></p>
<p>可以通过 quickjs 中 的 test 文件夹进行学习更多能力</p>
<p><img src="/../images/quickjs_01.png"></p>
<p>fetch.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import &#123; popen &#125; from &#x27;std&#x27;;</span><br><span class="line">export default function fetch(resource, init) &#123;</span><br><span class="line"></span><br><span class="line">    init = init || &#123;</span><br><span class="line">        method: &#x27;GET&#x27;,</span><br><span class="line">        headers: null,</span><br><span class="line">        body: null,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    let spErr = &#123;&#125;</span><br><span class="line">    let curlCmd = `curl -s -X$&#123;init.method&#125; $&#123;resource&#125;`</span><br><span class="line"></span><br><span class="line">    if (init.headers != null) &#123;</span><br><span class="line">        curlCmd = `$&#123;curlCmd&#125; $&#123;Object.entries(init.headers).map(n=&gt; `-H &#x27;$&#123;n[0]&#125;: $&#123;n[1]&#125;&#x27;`).join(&#x27; &#x27;)&#125;`</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    if (init.method != &#x27;GET&#x27;)</span><br><span class="line">    &#123;</span><br><span class="line">      curlCmd = `$&#123;curlCmd&#125; -d &#x27;$&#123;init.body&#125;&#x27;`</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    console.log(curlCmd);</span><br><span class="line">    let sp = popen(curlCmd, &#x27;r&#x27;, spErr);</span><br><span class="line">    let curlOutput = sp.readAsString();</span><br><span class="line">    let responseUrl = resource;</span><br><span class="line">    let responseHeaders = &#123;&#125;;</span><br><span class="line">    let responseOk = true;</span><br><span class="line">    let responseStatus = 200;</span><br><span class="line">    </span><br><span class="line">    console.log(curlOutput)</span><br><span class="line">    </span><br><span class="line">    let p = new Promise(function(resolve, reject) &#123;</span><br><span class="line"></span><br><span class="line">        let response = &#123;</span><br><span class="line">            headers: responseHeaders,</span><br><span class="line">            ok: responseOk,</span><br><span class="line">            url: responseUrl,</span><br><span class="line">            json: () =&gt; JSON.parse(curlOutput),</span><br><span class="line">            text: () =&gt; curlOutput,</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        resolve(response);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>fetch.js 使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import fetch from &#x27;./fetch.js&#x27;;</span><br><span class="line"></span><br><span class="line">const url = &#x27;https://jsonplaceholder.typicode.com/todos/1&#x27;;</span><br><span class="line"></span><br><span class="line">fetch(url)</span><br><span class="line">  .then(data =&gt; &#123;</span><br><span class="line">      console.log(JSON.stringify(data));</span><br><span class="line">      return data.json();</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(res =&gt; &#123;</span><br><span class="line">    console.log(JSON.stringify(res));</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(err =&gt; &#123;</span><br><span class="line">    console.log(&#x27;err:&#x27; + JSON.stringify(err));</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">fetch(&#x27;https://jsonplaceholder.typicode.com/posts&#x27;, &#123; method: &#x27;POST&#x27;, headers: &#123;&#x27;Content-Type&#x27;: &#x27;application/json; charset=UTF-8&#x27;&#125;, body: JSON.stringify(&#123;&#x27;title&#x27;: &#x27;foo&#x27;, &#x27;body&#x27;: &#x27;bar&#x27;, &#x27;userId&#x27;: 1&#125;)&#125;)</span><br><span class="line">  .then(data =&gt; &#123;</span><br><span class="line">      console.log(JSON.stringify(data));</span><br><span class="line">      return data.json();</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(res =&gt; &#123;</span><br><span class="line">    console.log(JSON.stringify(res));</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(err =&gt; &#123;</span><br><span class="line">    console.log(&#x27;err:&#x27; + JSON.stringify(err));</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>fetch.js  + redaxios.js 使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import redaxios from &#x27;./redaxios.js&#x27;;</span><br><span class="line">import fetch from &#x27;./fetch.js&#x27;;</span><br><span class="line"></span><br><span class="line">const axios = redaxios.create(&#123;fetch, responseType: &#x27;json&#x27; &#125;);</span><br><span class="line"></span><br><span class="line">// 定义请求的 URL 和配置</span><br><span class="line">const url = &#x27;https://jsonplaceholder.typicode.com/todos/1&#x27;;</span><br><span class="line"></span><br><span class="line">axios.get(url)</span><br><span class="line">  .then(res =&gt; res.data)</span><br><span class="line">  .then(data =&gt; &#123;</span><br><span class="line">    console.log(JSON.stringify(data))</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">axios.post(&#x27;https://jsonplaceholder.typicode.com/posts&#x27;, &#123; &#x27;title&#x27;: &#x27;foo&#x27;, &#x27;body&#x27;: &#x27;bar&#x27;, &#x27;userId&#x27;: 1 &#125;)</span><br><span class="line">  .then(res =&gt; res.data)</span><br><span class="line">  .then(data =&gt; &#123;</span><br><span class="line">    console.log(JSON.stringify(data))</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(err =&gt; &#123;</span><br><span class="line">    console.log(err.stack);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>redaxios.js 修改版</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Copyright 2018 Google Inc. All Rights Reserved.</span><br><span class="line"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line"> * you may not use this file except in compliance with the License.</span><br><span class="line"> * You may obtain a copy of the License at</span><br><span class="line"> *     http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @public</span><br><span class="line"> * @typedef Options</span><br><span class="line"> * @property &#123;string&#125; [url] the URL to request</span><br><span class="line"> * @property &#123;&#x27;get&#x27;|&#x27;post&#x27;|&#x27;put&#x27;|&#x27;patch&#x27;|&#x27;delete&#x27;|&#x27;options&#x27;|&#x27;head&#x27;|&#x27;GET&#x27;|&#x27;POST&#x27;|&#x27;PUT&#x27;|&#x27;PATCH&#x27;|&#x27;DELETE&#x27;|&#x27;OPTIONS&#x27;|&#x27;HEAD&#x27;&#125; [method=&quot;get&quot;] HTTP method, case-insensitive</span><br><span class="line"> * @property &#123;RequestHeaders&#125; [headers] Request headers</span><br><span class="line"> * @property &#123;FormData|string|object&#125; [body] a body, optionally encoded, to send</span><br><span class="line"> * @property &#123;&#x27;text&#x27;|&#x27;json&#x27;|&#x27;stream&#x27;|&#x27;blob&#x27;|&#x27;arrayBuffer&#x27;|&#x27;formData&#x27;|&#x27;stream&#x27;&#125; [responseType=&quot;json&quot;] An encoding to use for the response</span><br><span class="line"> * @property &#123;Record&lt;string,any&gt;|URLSearchParams&#125; [params] querystring parameters</span><br><span class="line"> * @property &#123;(params: Options[&#x27;params&#x27;]) =&gt; string&#125; [paramsSerializer] custom function to stringify querystring parameters</span><br><span class="line"> * @property &#123;boolean&#125; [withCredentials] Send the request with credentials like cookies</span><br><span class="line"> * @property &#123;string&#125; [auth] Authorization header value to send with the request</span><br><span class="line"> * @property &#123;string&#125; [xsrfCookieName] Pass an Cross-site Request Forgery prevention cookie value as a header defined by `xsrfHeaderName`</span><br><span class="line"> * @property &#123;string&#125; [xsrfHeaderName] The name of a header to use for passing XSRF cookies</span><br><span class="line"> * @property &#123;(status: number) =&gt; boolean&#125; [validateStatus] Override status code handling (default: 200-399 is a success)</span><br><span class="line"> * @property &#123;Array&lt;(body: any, headers?: RequestHeaders) =&gt; any?&gt;&#125; [transformRequest] An array of transformations to apply to the outgoing request</span><br><span class="line"> * @property &#123;string&#125; [baseURL] a base URL from which to resolve all URLs</span><br><span class="line"> * @property &#123;typeof window.fetch&#125; [fetch] Custom window.fetch implementation</span><br><span class="line"> * @property &#123;any&#125; [data]</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @public</span><br><span class="line"> * @typedef RequestHeaders</span><br><span class="line"> * @type &#123;&#123;[name: string]: string&#125; | Headers&#125;</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @public</span><br><span class="line"> * @template T</span><br><span class="line"> * @typedef Response</span><br><span class="line"> * @property &#123;number&#125; status</span><br><span class="line"> * @property &#123;string&#125; statusText</span><br><span class="line"> * @property &#123;Options&#125; config the request configuration</span><br><span class="line"> * @property &#123;T&#125; data the decoded response body</span><br><span class="line"> * @property &#123;Headers&#125; headers</span><br><span class="line"> * @property &#123;boolean&#125; redirect</span><br><span class="line"> * @property &#123;string&#125; url</span><br><span class="line"> * @property &#123;ResponseType&#125; type</span><br><span class="line"> * @property &#123;ReadableStream&lt;Uint8Array&gt; | null&#125; body</span><br><span class="line"> * @property &#123;boolean&#125; bodyUsed</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @typedef BodylessMethod</span><br><span class="line"> * @type &#123;&lt;T=any&gt;(url: string, config?: Options) =&gt; Promise&lt;Response&lt;T&gt;&gt;&#125;</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @typedef BodyMethod</span><br><span class="line"> * @type &#123;&lt;T=any&gt;(url: string, body?: any, config?: Options) =&gt; Promise&lt;Response&lt;T&gt;&gt;&#125;</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @public</span><br><span class="line"> * @param &#123;Options&#125; [defaults = &#123;&#125;]</span><br><span class="line"> * @returns &#123;redaxios&#125;</span><br><span class="line"> */</span><br><span class="line">function create(defaults) &#123;</span><br><span class="line">  defaults = defaults || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @public</span><br><span class="line">   * @template T</span><br><span class="line">   * @type &#123;(&lt;T = any&gt;(config?: Options) =&gt; Promise&lt;Response&lt;T&gt;&gt;) | (&lt;T = any&gt;(url: string, config?: Options) =&gt; Promise&lt;Response&lt;T&gt;&gt;)&#125;</span><br><span class="line">   */</span><br><span class="line">  redaxios.request = redaxios;</span><br><span class="line"></span><br><span class="line">  /** @public @type &#123;BodylessMethod&#125; */</span><br><span class="line">  redaxios.get = (url, config) =&gt; redaxios(url, config, &#x27;get&#x27;);</span><br><span class="line"></span><br><span class="line">  /** @public @type &#123;BodylessMethod&#125; */</span><br><span class="line">  redaxios.delete = (url, config) =&gt; redaxios(url, config, &#x27;delete&#x27;);</span><br><span class="line"></span><br><span class="line">  /** @public @type &#123;BodylessMethod&#125; */</span><br><span class="line">  redaxios.head = (url, config) =&gt; redaxios(url, config, &#x27;head&#x27;);</span><br><span class="line"></span><br><span class="line">  /** @public @type &#123;BodylessMethod&#125; */</span><br><span class="line">  redaxios.options = (url, config) =&gt; redaxios(url, config, &#x27;options&#x27;);</span><br><span class="line"></span><br><span class="line">  /** @public @type &#123;BodyMethod&#125; */</span><br><span class="line">  redaxios.post = (url, data, config) =&gt; redaxios(url, config, &#x27;post&#x27;, data);</span><br><span class="line"></span><br><span class="line">  /** @public @type &#123;BodyMethod&#125; */</span><br><span class="line">  redaxios.put = (url, data, config) =&gt; redaxios(url, config, &#x27;put&#x27;, data);</span><br><span class="line"></span><br><span class="line">  /** @public @type &#123;BodyMethod&#125; */</span><br><span class="line">  redaxios.patch = (url, data, config) =&gt; redaxios(url, config, &#x27;patch&#x27;, data);</span><br><span class="line"></span><br><span class="line">  /** @public */</span><br><span class="line">  redaxios.all = Promise.all.bind(Promise);</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @public</span><br><span class="line">   * @template Args, R</span><br><span class="line">   * @param &#123;(...args: Args[]) =&gt; R&#125; fn</span><br><span class="line">   * @returns &#123;(array: Args[]) =&gt; R&#125;</span><br><span class="line">   */</span><br><span class="line">  redaxios.spread = (fn) =&gt; /** @type &#123;any&#125; */ (fn.apply.bind(fn, fn));</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @private</span><br><span class="line">   * @template T, U</span><br><span class="line">   * @param &#123;T&#125; opts</span><br><span class="line">   * @param &#123;U&#125; [overrides]</span><br><span class="line">   * @param &#123;boolean&#125; [lowerCase]</span><br><span class="line">   * @returns &#123;&#123;&#125; &amp; (T | U)&#125;</span><br><span class="line">   */</span><br><span class="line">  function deepMerge(opts, overrides, lowerCase) &#123;</span><br><span class="line">    let out = /** @type &#123;any&#125; */ (&#123;&#125;),</span><br><span class="line">      i;</span><br><span class="line">    if (Array.isArray(opts)) &#123;</span><br><span class="line">      // @ts-ignore</span><br><span class="line">      return opts.concat(overrides);</span><br><span class="line">    &#125;</span><br><span class="line">    for (i in opts) &#123;</span><br><span class="line">      const key = lowerCase ? i.toLowerCase() : i;</span><br><span class="line">      out[key] = opts[i];</span><br><span class="line">    &#125;</span><br><span class="line">    for (i in overrides) &#123;</span><br><span class="line">      const key = lowerCase ? i.toLowerCase() : i;</span><br><span class="line">      const value = /** @type &#123;any&#125; */ (overrides)[i];</span><br><span class="line">      out[key] = key in out &amp;&amp; typeof value == &#x27;object&#x27; ? deepMerge(out[key], value, key == &#x27;headers&#x27;) : value;</span><br><span class="line">    &#125;</span><br><span class="line">    return out;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Issues a request.</span><br><span class="line">   * @public</span><br><span class="line">   * @template T</span><br><span class="line">   * @param &#123;string | Options&#125; urlOrConfig</span><br><span class="line">   * @param &#123;Options&#125; [config = &#123;&#125;]</span><br><span class="line">   * @param &#123;any&#125; [_method] (internal)</span><br><span class="line">   * @param &#123;any&#125; [data] (internal)</span><br><span class="line">   * @param &#123;never&#125; [_undefined] (internal)</span><br><span class="line">   * @returns &#123;Promise&lt;Response&lt;T&gt;&gt;&#125;</span><br><span class="line">   */</span><br><span class="line">  function redaxios(urlOrConfig, config, _method, data, _undefined) &#123;</span><br><span class="line">    let url = /** @type &#123;string&#125; */ (typeof urlOrConfig != &#x27;string&#x27; ? (config = urlOrConfig).url : urlOrConfig);</span><br><span class="line"></span><br><span class="line">    const response = /** @type &#123;Response&lt;any&gt;&#125; */ (&#123; config &#125;);</span><br><span class="line"></span><br><span class="line">    /** @type &#123;Options&#125; */</span><br><span class="line">    const options = deepMerge(defaults, config);</span><br><span class="line"></span><br><span class="line">    /** @type &#123;RequestHeaders&#125; */</span><br><span class="line">    const customHeaders = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    data = data || options.data;</span><br><span class="line"></span><br><span class="line">    (options.transformRequest || []).map((f) =&gt; &#123;</span><br><span class="line">      data = f(data, options.headers) || data;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    if (options.auth) &#123;</span><br><span class="line">      customHeaders.authorization = options.auth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (data &amp;&amp; typeof data === &#x27;object&#x27; &amp;&amp; typeof data.append !== &#x27;function&#x27; &amp;&amp; typeof data.text !== &#x27;function&#x27;) &#123;</span><br><span class="line">      data = JSON.stringify(data);</span><br><span class="line">      customHeaders[&#x27;content-type&#x27;] = &#x27;application/json&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      // @ts-ignore providing the cookie name without header name is nonsensical anyway</span><br><span class="line">      customHeaders[options.xsrfHeaderName] = decodeURIComponent(</span><br><span class="line">        // @ts-ignore accessing match()[2] throws for no match, which is intentional</span><br><span class="line">        document.cookie.match(RegExp(&#x27;(^|; )&#x27; + options.xsrfCookieName + &#x27;=([^;]*)&#x27;))[2]</span><br><span class="line">      );</span><br><span class="line">    &#125; catch (e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    if (options.baseURL) &#123;</span><br><span class="line">      url = url.replace(/^(?!.*\/\/)\/?/, options.baseURL + &#x27;/&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (options.params) &#123;</span><br><span class="line">      url +=</span><br><span class="line">        (~url.indexOf(&#x27;?&#x27;) ? &#x27;&amp;&#x27; : &#x27;?&#x27;) +</span><br><span class="line">        (options.paramsSerializer ? options.paramsSerializer(options.params) : new URLSearchParams(options.params));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    const fetchFunc = options.fetch || fetch;</span><br><span class="line"></span><br><span class="line">    return fetchFunc(url, &#123;</span><br><span class="line">      method: (_method || options.method || &#x27;get&#x27;).toUpperCase(),</span><br><span class="line">      body: data,</span><br><span class="line">      headers: deepMerge(options.headers, customHeaders, true),</span><br><span class="line">      credentials: options.withCredentials ? &#x27;include&#x27; : _undefined</span><br><span class="line">    &#125;).then((res) =&gt; &#123;</span><br><span class="line">      for (const i in res) &#123;</span><br><span class="line">        if (typeof res[i] != &#x27;function&#x27;) response[i] = res[i];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      if (options.responseType == &#x27;stream&#x27;) &#123;</span><br><span class="line">        response.data = res.body;</span><br><span class="line">        return response;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      /*</span><br><span class="line"></span><br><span class="line">      return res[options.responseType || &#x27;text&#x27;]()</span><br><span class="line">        .then((data) =&gt; &#123;</span><br><span class="line">          response.data = data;</span><br><span class="line">          // its okay if this fails: response.data will be the unparsed value:</span><br><span class="line">          response.data = JSON.parse(data);</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(Object)</span><br><span class="line">        .then(() =&gt; &#123;</span><br><span class="line">          const ok = options.validateStatus ? options.validateStatus(res.status) : res.ok;</span><br><span class="line">          return ok ? response : Promise.reject(response);</span><br><span class="line">        &#125;);</span><br><span class="line">        */</span><br><span class="line">      </span><br><span class="line">      const fn = res[options.responseType || &#x27;text&#x27;];</span><br><span class="line">      const data = fn();</span><br><span class="line">      response.data = data;</span><br><span class="line">      return response;</span><br><span class="line">      </span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @public</span><br><span class="line">   * @type &#123;AbortController&#125;</span><br><span class="line">   */</span><br><span class="line">  redaxios.CancelToken = /** @type &#123;any&#125; */ (typeof AbortController == &#x27;function&#x27; ? AbortController : Object);</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @public</span><br><span class="line">   * @type &#123;Options&#125;</span><br><span class="line">   */</span><br><span class="line">  redaxios.defaults = defaults;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * @public</span><br><span class="line">   */</span><br><span class="line">  redaxios.create = create;</span><br><span class="line"></span><br><span class="line">  return redaxios;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default create();</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><img src="/../images/quickjs_02.png"></p>
<p>quickjs 中使用 lodash<br>安装 lodash 命令行工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cnpm i -g lodash-cli</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>clone lodash 仓库<br>执行以下命令输出 es6 modules 文件列表到 out 目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lodash modularize exports=es -o ./out</span><br></pre></td></tr></table></figure>

<p>演示代码（备注：其中 debounce 仓库用到了 setTimeout 方法，quickjs 中  ）</p>
<p>需要在打包好的debounce.js 中引入 setTimeout 方法才可以正常使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import &#123;setTimeout&#125; from &quot;os&quot;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import throttle from &#x27;./lodash/throttle.js&#x27;;</span><br><span class="line">import debounce from &#x27;./lodash/debounce.js&#x27;;</span><br><span class="line"></span><br><span class="line">// 使用导入的函数</span><br><span class="line">const myDebounceFunction = debounce(() =&gt; &#123;</span><br><span class="line">  console.log(&#x27;This function has been debounced!&#x27;);</span><br><span class="line">&#125;, 1000);</span><br><span class="line"></span><br><span class="line">myDebounceFunction();</span><br><span class="line"></span><br><span class="line">const myThrottleFunction = throttle(() =&gt; &#123;</span><br><span class="line">  console.log(&#x27;This function has been throttled!&#x27;);</span><br><span class="line">&#125;, 1000);</span><br><span class="line"></span><br><span class="line">myThrottleFunction();</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>继续学习官方的demo</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wunaozai/p/17850789.html">https://www.cnblogs.com/wunaozai/p/17850789.html</a><br><a target="_blank" rel="noopener" href="https://github.com/OpenQuickJS/quickjs-android">https://github.com/OpenQuickJS/quickjs-android</a><br><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=uzLy9DfujfM">https://www.youtube.com/watch?v=uzLy9DfujfM</a><br><a target="_blank" rel="noopener" href="https://github.com/bojie-liu/react-native-quickjs">https://github.com/bojie-liu/react-native-quickjs</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/@bojieliu711/easily-use-quickjs-in-react-native-c7e650705ebf">https://medium.com/@bojieliu711/easily-use-quickjs-in-react-native-c7e650705ebf</a><br><a target="_blank" rel="noopener" href="https://github.com/taoweiji/miniprogram-double-thread-demo">https://github.com/taoweiji/miniprogram-double-thread-demo</a></p>
<p><a target="_blank" rel="noopener" href="https://www.w3.org/2023/09/TPAC/ac-lt-wasm-perf">https://www.w3.org/2023/09/TPAC/ac-lt-wasm-perf</a></p>
<h1 id="quickjs-如何操作-mysql"><a href="#quickjs-如何操作-mysql" class="headerlink" title="quickjs 如何操作 mysql"></a>quickjs 如何操作 mysql</h1><p>安装依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sudo apt-get install libmysqlclient-dev</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>mysql_module.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;../quickjs.h&quot;</span><br><span class="line">#include &lt;mysql/mysql.h&gt;</span><br><span class="line"></span><br><span class="line">#define countof(x) (sizeof(x) / sizeof((x)[0]))</span><br><span class="line"></span><br><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  MYSQL *conn;</span><br><span class="line">  int is_closed;  // 新增字段，用于标记连接是否已关闭</span><br><span class="line">&#125; MySQLClient;</span><br><span class="line"></span><br><span class="line">static JSClassID js_mysql_client_class_id;</span><br><span class="line"></span><br><span class="line">static void js_mysql_client_finalizer(JSRuntime *rt, JSValue val)</span><br><span class="line">&#123;</span><br><span class="line">  MySQLClient *client = JS_GetOpaque(val, js_mysql_client_class_id);</span><br><span class="line">  if (client &amp;&amp; client-&gt;conn &amp;&amp; !client-&gt;is_closed)</span><br><span class="line">  &#123;</span><br><span class="line">    mysql_close(client-&gt;conn);</span><br><span class="line">    js_free_rt(rt, client);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JSValue js_mysql_client_ctor(JSContext *ctx,</span><br><span class="line">                                    JSValueConst new_target,</span><br><span class="line">                                    int argc, JSValueConst *argv)</span><br><span class="line">&#123;</span><br><span class="line">  MySQLClient *client;</span><br><span class="line">  JSValue obj = JS_UNDEFINED;</span><br><span class="line">  JSValue proto;</span><br><span class="line">  const char *host = &quot;127.0.0.1&quot;;</span><br><span class="line">  const char *user = &quot;root&quot;;</span><br><span class="line">  const char *password = &quot;&quot;;</span><br><span class="line">  const char *database = &quot;&quot;;</span><br><span class="line">  unsigned int port = 3306;</span><br><span class="line"></span><br><span class="line">  client = js_mallocz(ctx, sizeof(*client));</span><br><span class="line">  if (!client)</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  if (argc &gt; 0 &amp;&amp; JS_IsString(argv[0]))</span><br><span class="line">  &#123;</span><br><span class="line">    host = JS_ToCString(ctx, argv[0]);</span><br><span class="line">  &#125;</span><br><span class="line">  if (argc &gt; 1 &amp;&amp; JS_IsString(argv[1]))</span><br><span class="line">  &#123;</span><br><span class="line">    user = JS_ToCString(ctx, argv[1]);</span><br><span class="line">  &#125;</span><br><span class="line">  if (argc &gt; 2 &amp;&amp; JS_IsString(argv[2]))</span><br><span class="line">  &#123;</span><br><span class="line">    password = JS_ToCString(ctx, argv[2]);</span><br><span class="line">  &#125;</span><br><span class="line">  if (argc &gt; 3 &amp;&amp; JS_IsString(argv[3]))</span><br><span class="line">  &#123;</span><br><span class="line">    database = JS_ToCString(ctx, argv[3]);</span><br><span class="line">  &#125;</span><br><span class="line">  if (argc &gt; 4 &amp;&amp; JS_IsNumber(argv[4]))</span><br><span class="line">  &#123;</span><br><span class="line">    JS_ToUint32(ctx, &amp;port, argv[4]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  client-&gt;conn = mysql_init(NULL);</span><br><span class="line">  if (mysql_real_connect(client-&gt;conn, host, user, password, database, port, NULL, 0) == NULL)</span><br><span class="line">  &#123;</span><br><span class="line">    fprintf(stderr, &quot;MySQL connection error: %s\n&quot;, mysql_error(client-&gt;conn));</span><br><span class="line">    mysql_close(client-&gt;conn);</span><br><span class="line">    js_free(ctx, client);</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  proto = JS_GetPropertyStr(ctx, new_target, &quot;prototype&quot;);</span><br><span class="line">  if (JS_IsException(proto))</span><br><span class="line">    goto fail;</span><br><span class="line">  obj = JS_NewObjectProtoClass(ctx, proto, js_mysql_client_class_id);</span><br><span class="line">  JS_FreeValue(ctx, proto);</span><br><span class="line">  if (JS_IsException(obj))</span><br><span class="line">    goto fail;</span><br><span class="line">  JS_SetOpaque(obj, client);</span><br><span class="line">  return obj;</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">  js_free(ctx, client);</span><br><span class="line">  JS_FreeValue(ctx, obj);</span><br><span class="line">  return JS_EXCEPTION;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JSValue js_mysql_query(JSContext *ctx, JSValueConst this_val,</span><br><span class="line">                              int argc, JSValueConst *argv)</span><br><span class="line">&#123;</span><br><span class="line">  MySQLClient *client = JS_GetOpaque2(ctx, this_val, js_mysql_client_class_id);</span><br><span class="line">  if (!client || !client-&gt;conn || client-&gt;is_closed)</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  const char *query;</span><br><span class="line">  if (argc &lt; 1 || !JS_IsString(argv[0]))</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  query = JS_ToCString(ctx, argv[0]);</span><br><span class="line"></span><br><span class="line">  if (mysql_query(client-&gt;conn, query))</span><br><span class="line">  &#123;</span><br><span class="line">    fprintf(stderr, &quot;MySQL query error: %s\n&quot;, mysql_error(client-&gt;conn));</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  MYSQL_RES *result = mysql_store_result(client-&gt;conn);</span><br><span class="line">  if (result)</span><br><span class="line">  &#123;</span><br><span class="line">    MYSQL_ROW row;</span><br><span class="line">    JSValue result_array = JS_NewArray(ctx);</span><br><span class="line"></span><br><span class="line">    int row_index = 0;</span><br><span class="line">    while ((row = mysql_fetch_row(result)))</span><br><span class="line">    &#123;</span><br><span class="line">      JSValue row_obj = JS_NewObject(ctx);</span><br><span class="line">      for (int i = 0; i &lt; mysql_num_fields(result); i++)</span><br><span class="line">      &#123;</span><br><span class="line">        const char *field_name = mysql_fetch_field_direct(result, i)-&gt;name;</span><br><span class="line">        JS_SetPropertyStr(ctx, row_obj, field_name, JS_NewString(ctx, row[i]));</span><br><span class="line">      &#125;</span><br><span class="line">      JS_SetPropertyUint32(ctx, result_array, row_index++, row_obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mysql_free_result(result);</span><br><span class="line">    return result_array;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return JS_UNDEFINED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JSValue js_mysql_insert(JSContext *ctx, JSValueConst this_val,</span><br><span class="line">                               int argc, JSValueConst *argv)</span><br><span class="line">&#123;</span><br><span class="line">  MySQLClient *client = JS_GetOpaque2(ctx, this_val, js_mysql_client_class_id);</span><br><span class="line">  if (!client || !client-&gt;conn || client-&gt;is_closed)</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  const char *query;</span><br><span class="line">  if (argc &lt; 1 || !JS_IsString(argv[0]))</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  query = JS_ToCString(ctx, argv[0]);</span><br><span class="line"></span><br><span class="line">  if (mysql_query(client-&gt;conn, query))</span><br><span class="line">  &#123;</span><br><span class="line">    fprintf(stderr, &quot;MySQL insert error: %s\n&quot;, mysql_error(client-&gt;conn));</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return JS_NewInt32(ctx, mysql_insert_id(client-&gt;conn));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JSValue js_mysql_update(JSContext *ctx, JSValueConst this_val,</span><br><span class="line">                               int argc, JSValueConst *argv)</span><br><span class="line">&#123;</span><br><span class="line">  MySQLClient *client = JS_GetOpaque2(ctx, this_val, js_mysql_client_class_id);</span><br><span class="line">  if (!client || !client-&gt;conn || client-&gt;is_closed)</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  const char *query;</span><br><span class="line">  if (argc &lt; 1 || !JS_IsString(argv[0]))</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  query = JS_ToCString(ctx, argv[0]);</span><br><span class="line"></span><br><span class="line">  if (mysql_query(client-&gt;conn, query))</span><br><span class="line">  &#123;</span><br><span class="line">    fprintf(stderr, &quot;MySQL update error: %s\n&quot;, mysql_error(client-&gt;conn));</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return JS_NewInt32(ctx, mysql_affected_rows(client-&gt;conn));</span><br><span class="line">&#125;</span><br><span class="line">static JSValue js_mysql_delete(JSContext *ctx, JSValueConst this_val,</span><br><span class="line">                               int argc, JSValueConst *argv)</span><br><span class="line">&#123;</span><br><span class="line">  MySQLClient *client = JS_GetOpaque2(ctx, this_val, js_mysql_client_class_id);</span><br><span class="line">  if (!client || !client-&gt;conn || client-&gt;is_closed)</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  const char *query;</span><br><span class="line">  if (argc &lt; 1 || !JS_IsString(argv[0]))</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  query = JS_ToCString(ctx, argv[0]);</span><br><span class="line"></span><br><span class="line">  if (mysql_query(client-&gt;conn, query))</span><br><span class="line">  &#123;</span><br><span class="line">    fprintf(stderr, &quot;MySQL delete error: %s\n&quot;, mysql_error(client-&gt;conn));</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return JS_NewInt32(ctx, mysql_affected_rows(client-&gt;conn));</span><br><span class="line">&#125;</span><br><span class="line">static JSValue js_mysql_close(JSContext *ctx, JSValueConst this_val,</span><br><span class="line">                              int argc, JSValueConst *argv)</span><br><span class="line">&#123;</span><br><span class="line">  MySQLClient *client = JS_GetOpaque2(ctx, this_val, js_mysql_client_class_id);</span><br><span class="line">  if (!client || !client-&gt;conn || client-&gt;is_closed)</span><br><span class="line">    return JS_UNDEFINED;</span><br><span class="line"></span><br><span class="line">  mysql_close(client-&gt;conn);</span><br><span class="line">  client-&gt;conn = NULL;</span><br><span class="line">  client-&gt;is_closed = 1;</span><br><span class="line"></span><br><span class="line">  return JS_UNDEFINED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JSClassDef js_mysql_client_class = &#123;</span><br><span class="line">    &quot;MySQLClient&quot;,</span><br><span class="line">    .finalizer = js_mysql_client_finalizer,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const JSCFunctionListEntry js_mysql_client_proto_funcs[] = &#123;</span><br><span class="line">    JS_CFUNC_DEF(&quot;query&quot;, 1, js_mysql_query),</span><br><span class="line">    JS_CFUNC_DEF(&quot;insert&quot;, 1, js_mysql_insert),</span><br><span class="line">    JS_CFUNC_DEF(&quot;update&quot;, 1, js_mysql_update),</span><br><span class="line">    JS_CFUNC_DEF(&quot;delete&quot;, 1, js_mysql_delete),  // 新增这一行</span><br><span class="line">    JS_CFUNC_DEF(&quot;close&quot;, 0, js_mysql_close),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int js_mysql_client_init(JSContext *ctx, JSModuleDef *m)</span><br><span class="line">&#123;</span><br><span class="line">  JSValue mysql_proto, mysql_class;</span><br><span class="line"></span><br><span class="line">  JS_NewClassID(&amp;js_mysql_client_class_id);</span><br><span class="line">  JS_NewClass(JS_GetRuntime(ctx), js_mysql_client_class_id, &amp;js_mysql_client_class);</span><br><span class="line"></span><br><span class="line">  mysql_proto = JS_NewObject(ctx);</span><br><span class="line">  JS_SetPropertyFunctionList(ctx, mysql_proto, js_mysql_client_proto_funcs, countof(js_mysql_client_proto_funcs));</span><br><span class="line"></span><br><span class="line">  mysql_class = JS_NewCFunction2(ctx, js_mysql_client_ctor, &quot;MySQLClient&quot;, 5, JS_CFUNC_constructor, 0);</span><br><span class="line">  JS_SetConstructor(ctx, mysql_class, mysql_proto);</span><br><span class="line">  JS_SetClassProto(ctx, js_mysql_client_class_id, mysql_proto);</span><br><span class="line"></span><br><span class="line">  JS_SetModuleExport(ctx, m, &quot;MySQLClient&quot;, mysql_class);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JSModuleDef *js_init_module(JSContext *ctx, const char *module_name)</span><br><span class="line">&#123;</span><br><span class="line">  JSModuleDef *m;</span><br><span class="line">  m = JS_NewCModule(ctx, module_name, js_mysql_client_init);</span><br><span class="line">  if (!m)</span><br><span class="line">    return NULL;</span><br><span class="line">  JS_AddModuleExport(ctx, m, &quot;MySQLClient&quot;);</span><br><span class="line">  return m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">gcc -shared -o libmysql_module.so -fPIC examples/mysql_module.c -L/home/dc/wzw/study/quickjs_yoga/quickjs -lmysqlclient -lquickjs</span><br><span class="line">mv libmysql_module.so ./examples/</span><br><span class="line">./qjs examples/test_mysql.js</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>test_mysql.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import * as mysql from &#x27;./libmysql_module.so&#x27;;</span><br><span class="line"></span><br><span class="line">const client = new mysql.MySQLClient(&#x27;127.0.0.1&#x27;, &#x27;admin&#x27;, &#x27;Jason@#123&#x27;, &#x27;big_event&#x27;);</span><br><span class="line"></span><br><span class="line">// // 查询数据</span><br><span class="line">// const result = client.query(&#x27;SELECT * FROM user&#x27;);</span><br><span class="line">// console.log(JSON.stringify(result));</span><br><span class="line"></span><br><span class="line">// // 插入数据</span><br><span class="line">// const insertId = client.insert(&#x27;INSERT INTO user (username, password, create_time, update_time) VALUES (&quot;aAlice111&quot;, &quot;aaaa&quot;, &quot;2024-08-22 09:31:58&quot;, &quot;2024-08-22 09:31:58&quot;)&#x27;);</span><br><span class="line">// console.log(insertId);</span><br><span class="line"></span><br><span class="line">// // 更新数据</span><br><span class="line">// const affectedRows = client.update(&#x27;UPDATE user SET username = &quot;Bo1b&quot; WHERE id = 1&#x27;);</span><br><span class="line">// console.log(affectedRows);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//删除数据</span><br><span class="line">const daffectedRows = client.delete(&quot;DELETE FROM user WHERE id = 1&quot;)</span><br><span class="line">console.log(daffectedRows);</span><br><span class="line"></span><br><span class="line">// 关闭连接</span><br><span class="line">client.close();</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ldd examples&#x2F;libmysql_module.so</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">ldd examples/libmysql_module.so</span><br><span class="line">        linux-vdso.so.1 (0x00007fff1318a000)</span><br><span class="line">        libmysqlclient.so.21 =&gt; /lib/x86_64-linux-gnu/libmysqlclient.so.21 (0x00007f0203bf7000)</span><br><span class="line">        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f0203a05000)</span><br><span class="line">        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f02039ff000)</span><br><span class="line">        libssl.so.1.1 =&gt; /lib/x86_64-linux-gnu/libssl.so.1.1 (0x00007f020396c000)</span><br><span class="line">        libcrypto.so.1.1 =&gt; /lib/x86_64-linux-gnu/libcrypto.so.1.1 (0x00007f0203695000)</span><br><span class="line">        libresolv.so.2 =&gt; /lib/x86_64-linux-gnu/libresolv.so.2 (0x00007f0203677000)</span><br><span class="line">        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f0203654000)</span><br><span class="line">        libstdc++.so.6 =&gt; /lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007f0203472000)</span><br><span class="line">        libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f0203457000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007f020441a000)</span><br><span class="line">        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f0203308000)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ldd 命令用于显示动态链接库的依赖关系。它可以帮助你了解某个可执行文件或共享库依赖于哪些其他共享库，并显示这些库的具体路径。以下是 ldd 命令的主要功能和用法：</span><br><span class="line">显示依赖库：</span><br><span class="line">列出目标文件（可执行文件或共享库）所依赖的所有共享库及其路径。</span><br><span class="line">检查库文件完整性：</span><br><span class="line">确认所有依赖的库文件是否存在，并且路径正确。</span><br><span class="line">调试链接问题：</span><br><span class="line">帮助诊断由于缺少依赖库或路径错误导致的程序启动失败或运行时错误。</span><br><span class="line">用法</span><br><span class="line">ldd [选项] 文件</span><br><span class="line">常用选项</span><br><span class="line">-v 或 --verbose：显示详细信息，包括版本信息和符号解析。</span><br><span class="line">-u 或 --unused：显示未使用的直接依赖库。</span><br><span class="line">-d 或 --data-relocs：处理数据重定位。</span><br><span class="line">-r 或 --function-relocs：处理数据和函数重定位。</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="quickjs-如何操作-redis"><a href="#quickjs-如何操作-redis" class="headerlink" title="quickjs 如何操作 redis"></a>quickjs 如何操作 redis</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libmysqlclient-dev</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>redis_module.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;../quickjs.h&quot;</span><br><span class="line">#include &lt;hiredis/hiredis.h&gt;</span><br><span class="line"></span><br><span class="line">#define countof(x) (sizeof(x) / sizeof((x)[0]))</span><br><span class="line"></span><br><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  redisContext *context;</span><br><span class="line">  int is_closed;  // 新增字段，用于标记连接是否已关闭</span><br><span class="line">&#125; RedisClient;</span><br><span class="line"></span><br><span class="line">static JSClassID js_redis_client_class_id;</span><br><span class="line"></span><br><span class="line">static void js_redis_client_finalizer(JSRuntime *rt, JSValue val)</span><br><span class="line">&#123;</span><br><span class="line">  RedisClient *client = JS_GetOpaque(val, js_redis_client_class_id);</span><br><span class="line">  if (client &amp;&amp; client-&gt;context &amp;&amp; !client-&gt;is_closed)</span><br><span class="line">  &#123;</span><br><span class="line">    redisFree(client-&gt;context);</span><br><span class="line">    js_free_rt(rt, client);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JSValue js_redis_client_ctor(JSContext *ctx,</span><br><span class="line">                                    JSValueConst new_target,</span><br><span class="line">                                    int argc, JSValueConst *argv)</span><br><span class="line">&#123;</span><br><span class="line">  RedisClient *client;</span><br><span class="line">  JSValue obj = JS_UNDEFINED;</span><br><span class="line">  JSValue proto;</span><br><span class="line">  const char *host = &quot;127.0.0.1&quot;;</span><br><span class="line">  int port = 6379;</span><br><span class="line"></span><br><span class="line">  client = js_mallocz(ctx, sizeof(*client));</span><br><span class="line">  if (!client)</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  if (argc &gt; 0 &amp;&amp; JS_IsString(argv[0]))</span><br><span class="line">  &#123;</span><br><span class="line">    host = JS_ToCString(ctx, argv[0]);</span><br><span class="line">  &#125;</span><br><span class="line">  if (argc &gt; 1 &amp;&amp; JS_IsNumber(argv[1]))</span><br><span class="line">  &#123;</span><br><span class="line">    JS_ToInt32(ctx, &amp;port, argv[1]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  client-&gt;context = redisConnect(host, port);</span><br><span class="line">  if (client-&gt;context == NULL || client-&gt;context-&gt;err)</span><br><span class="line">  &#123;</span><br><span class="line">    if (client-&gt;context)</span><br><span class="line">    &#123;</span><br><span class="line">      fprintf(stderr, &quot;Connection error: %s\n&quot;, client-&gt;context-&gt;errstr);</span><br><span class="line">      redisFree(client-&gt;context);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      fprintf(stderr, &quot;Connection error: can&#x27;t allocate redis context\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    js_free(ctx, client);</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  proto = JS_GetPropertyStr(ctx, new_target, &quot;prototype&quot;);</span><br><span class="line">  if (JS_IsException(proto))</span><br><span class="line">    goto fail;</span><br><span class="line">  obj = JS_NewObjectProtoClass(ctx, proto, js_redis_client_class_id);</span><br><span class="line">  JS_FreeValue(ctx, proto);</span><br><span class="line">  if (JS_IsException(obj))</span><br><span class="line">    goto fail;</span><br><span class="line">  JS_SetOpaque(obj, client);</span><br><span class="line">  return obj;</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">  js_free(ctx, client);</span><br><span class="line">  JS_FreeValue(ctx, obj);</span><br><span class="line">  return JS_EXCEPTION;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JSValue js_redis_set(JSContext *ctx, JSValueConst this_val,</span><br><span class="line">                            int argc, JSValueConst *argv)</span><br><span class="line">&#123;</span><br><span class="line">  RedisClient *client = JS_GetOpaque2(ctx, this_val, js_redis_client_class_id);</span><br><span class="line">  if (!client || !client-&gt;context || client-&gt;is_closed)</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  const char *key, *value;</span><br><span class="line">  int expire = 0;  // 默认不过期</span><br><span class="line"></span><br><span class="line">  if (argc &lt; 2 || !JS_IsString(argv[0]) || !JS_IsString(argv[1]))</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  if (argc &gt; 2 &amp;&amp; JS_IsNumber(argv[2]))</span><br><span class="line">  &#123;</span><br><span class="line">    JS_ToInt32(ctx, &amp;expire, argv[2]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  key = JS_ToCString(ctx, argv[0]);</span><br><span class="line">  value = JS_ToCString(ctx, argv[1]);</span><br><span class="line"></span><br><span class="line">  redisReply *reply;</span><br><span class="line">  if (expire &gt; 0)</span><br><span class="line">  &#123;</span><br><span class="line">    reply = (redisReply *)redisCommand(client-&gt;context, &quot;SET %s %s EX %d&quot;, key, value, expire);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    reply = (redisReply *)redisCommand(client-&gt;context, &quot;SET %s %s&quot;, key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (reply == NULL)</span><br><span class="line">  &#123;</span><br><span class="line">    fprintf(stderr, &quot;Error setting key: %s\n&quot;, client-&gt;context-&gt;errstr);</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  freeReplyObject(reply);</span><br><span class="line">  return JS_UNDEFINED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JSValue js_redis_get(JSContext *ctx, JSValueConst this_val,</span><br><span class="line">                            int argc, JSValueConst *argv)</span><br><span class="line">&#123;</span><br><span class="line">  RedisClient *client = JS_GetOpaque2(ctx, this_val, js_redis_client_class_id);</span><br><span class="line">  if (!client || !client-&gt;context || client-&gt;is_closed)</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  const char *key;</span><br><span class="line">  if (argc &lt; 1 || !JS_IsString(argv[0]))</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  key = JS_ToCString(ctx, argv[0]);</span><br><span class="line"></span><br><span class="line">  redisReply *reply = (redisReply *)redisCommand(client-&gt;context, &quot;GET %s&quot;, key);</span><br><span class="line">  if (reply == NULL)</span><br><span class="line">  &#123;</span><br><span class="line">    fprintf(stderr, &quot;Error getting key: %s\n&quot;, client-&gt;context-&gt;errstr);</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  JSValue result = JS_UNDEFINED;</span><br><span class="line">  if (reply-&gt;type == REDIS_REPLY_STRING)</span><br><span class="line">  &#123;</span><br><span class="line">    result = JS_NewString(ctx, reply-&gt;str);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  freeReplyObject(reply);</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JSValue js_redis_del(JSContext *ctx, JSValueConst this_val,</span><br><span class="line">                            int argc, JSValueConst *argv)</span><br><span class="line">&#123;</span><br><span class="line">  RedisClient *client = JS_GetOpaque2(ctx, this_val, js_redis_client_class_id);</span><br><span class="line">  if (!client || !client-&gt;context || client-&gt;is_closed)</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  const char *key;</span><br><span class="line">  if (argc &lt; 1 || !JS_IsString(argv[0]))</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line"></span><br><span class="line">  key = JS_ToCString(ctx, argv[0]);</span><br><span class="line"></span><br><span class="line">  redisReply *reply = (redisReply *)redisCommand(client-&gt;context, &quot;DEL %s&quot;, key);</span><br><span class="line">  if (reply == NULL)</span><br><span class="line">  &#123;</span><br><span class="line">    fprintf(stderr, &quot;Error deleting key: %s\n&quot;, client-&gt;context-&gt;errstr);</span><br><span class="line">    return JS_EXCEPTION;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  freeReplyObject(reply);</span><br><span class="line">  return JS_UNDEFINED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JSValue js_redis_close(JSContext *ctx, JSValueConst this_val,</span><br><span class="line">                              int argc, JSValueConst *argv)</span><br><span class="line">&#123;</span><br><span class="line">  RedisClient *client = JS_GetOpaque2(ctx, this_val, js_redis_client_class_id);</span><br><span class="line">  if (!client || !client-&gt;context || client-&gt;is_closed)</span><br><span class="line">    return JS_UNDEFINED;</span><br><span class="line"></span><br><span class="line">  redisFree(client-&gt;context);</span><br><span class="line">  client-&gt;context = NULL;</span><br><span class="line">  client-&gt;is_closed = 1;</span><br><span class="line"></span><br><span class="line">  return JS_UNDEFINED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static JSClassDef js_redis_client_class = &#123;</span><br><span class="line">    &quot;RedisClient&quot;,</span><br><span class="line">    .finalizer = js_redis_client_finalizer,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static const JSCFunctionListEntry js_redis_client_proto_funcs[] = &#123;</span><br><span class="line">    JS_CFUNC_DEF(&quot;set&quot;, 3, js_redis_set),</span><br><span class="line">    JS_CFUNC_DEF(&quot;get&quot;, 1, js_redis_get),</span><br><span class="line">    JS_CFUNC_DEF(&quot;del&quot;, 1, js_redis_del),</span><br><span class="line">    JS_CFUNC_DEF(&quot;close&quot;, 0, js_redis_close),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int js_redis_client_init(JSContext *ctx, JSModuleDef *m)</span><br><span class="line">&#123;</span><br><span class="line">  JSValue redis_proto, redis_class;</span><br><span class="line"></span><br><span class="line">  JS_NewClassID(&amp;js_redis_client_class_id);</span><br><span class="line">  JS_NewClass(JS_GetRuntime(ctx), js_redis_client_class_id, &amp;js_redis_client_class);</span><br><span class="line"></span><br><span class="line">  redis_proto = JS_NewObject(ctx);</span><br><span class="line">  JS_SetPropertyFunctionList(ctx, redis_proto, js_redis_client_proto_funcs, countof(js_redis_client_proto_funcs));</span><br><span class="line"></span><br><span class="line">  redis_class = JS_NewCFunction2(ctx, js_redis_client_ctor, &quot;RedisClient&quot;, 2, JS_CFUNC_constructor, 0);</span><br><span class="line">  JS_SetConstructor(ctx, redis_class, redis_proto);</span><br><span class="line">  JS_SetClassProto(ctx, js_redis_client_class_id, redis_proto);</span><br><span class="line"></span><br><span class="line">  JS_SetModuleExport(ctx, m, &quot;RedisClient&quot;, redis_class);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">JSModuleDef *js_init_module(JSContext *ctx, const char *module_name)</span><br><span class="line">&#123;</span><br><span class="line">  JSModuleDef *m;</span><br><span class="line">  m = JS_NewCModule(ctx, module_name, js_redis_client_init);</span><br><span class="line">  if (!m)</span><br><span class="line">    return NULL;</span><br><span class="line">  JS_AddModuleExport(ctx, m, &quot;RedisClient&quot;);</span><br><span class="line">  return m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -o libredis_module.so -fPIC examples/redis_module.c -L/home/dc/wzw/study/quickjs_yoga/quickjs -lhiredis -lquickjs</span><br><span class="line">mv libredis_module.so ./examples/</span><br><span class="line">qjs examples/test_redis.js</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调用编译好的 so 文件，进行 redis 操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">import&#123;RedisClient&#125; from &#x27;./libredis_module.so&#x27;;</span><br><span class="line"></span><br><span class="line">// 创建 Redis 客户端</span><br><span class="line">const redis = new RedisClient(&#x27;127.0.0.1&#x27;, 6379);</span><br><span class="line"></span><br><span class="line">// 设置键值对</span><br><span class="line">redis.set(&#x27;key2&#x27;, &#x27;value22&#x27;)</span><br><span class="line"></span><br><span class="line">// 获取键值对</span><br><span class="line">console.log(redis.get(&#x27;key2&#x27;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// import * as redis from &#x27;./libredis_module.so&#x27;;</span><br><span class="line"></span><br><span class="line">// const client = new redis.RedisClient();</span><br><span class="line"></span><br><span class="line">// client.set(&#x27;key&#x27;, &#x27;value&#x27;, 30);  // 设置键值对并指定过期时间为10秒</span><br><span class="line">// const value = client.get(&#x27;key&#x27;);</span><br><span class="line">// console.log(value); // 输出: value</span><br><span class="line"></span><br><span class="line">// client.del(&#x27;key&#x27;);  // 删除键</span><br><span class="line"></span><br><span class="line">// const deletedValue = client.get(&#x27;key&#x27;);</span><br><span class="line">// console.log(deletedValue); // 输出: undefined</span><br><span class="line"></span><br><span class="line">// client.close();  // 关闭连接</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="quickjs-yoga结合使用"><a href="#quickjs-yoga结合使用" class="headerlink" title="quickjs+yoga结合使用"></a>quickjs+yoga结合使用</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">QuickJS + Yoga 结合使用</span><br><span class="line">QuickJS 是一个轻量级的 JavaScript 引擎，由 Mozilla 开发，适用于嵌入式系统和高性能应用。Yoga 是 Facebook 开发的一个跨平台布局引擎，基于 Flexbox 布局算法。结合 QuickJS 和 Yoga，可以在 JavaScript 中实现高效的布局管理，特别适合用于构建跨平台的应用程序。</span><br><span class="line"></span><br><span class="line">以下是一个简单的示例，展示如何在 QuickJS 中使用 Yoga 进行布局计算。</span><br><span class="line"></span><br><span class="line">1. 安装依赖</span><br><span class="line">首先，确保你已经安装了 QuickJS 和 Yoga。你可以从各自的 GitHub 仓库获取源代码并编译安装。</span><br><span class="line"></span><br><span class="line">QuickJS: https://github.com/bellard/quickjs</span><br><span class="line">Yoga: https://github.com/facebook/yoga</span><br><span class="line">2. 编写 C 代码</span><br><span class="line">创建一个 C 文件（例如 main.c），用于初始化 QuickJS 和 Yoga，并提供 JavaScript 接口。</span><br><span class="line"></span><br><span class="line">c</span><br><span class="line">#include &quot;quickjs.h&quot;</span><br><span class="line">#include &quot;yoga/YGNode.h&quot;</span><br><span class="line"></span><br><span class="line">// 初始化 Yoga 节点</span><br><span class="line">YGNodeRef createYogaNode() &#123;</span><br><span class="line">    YGNodeRef node = YGNodeNew();</span><br><span class="line">    return node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 设置 Yoga 节点的宽度</span><br><span class="line">void setWidth(YGNodeRef node, float width) &#123;</span><br><span class="line">    YGNodeStyleSetWidth(node, width);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 设置 Yoga 节点的高度</span><br><span class="line">void setHeight(YGNodeRef node, float height) &#123;</span><br><span class="line">    YGNodeStyleSetHeight(node, height);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 设置 Yoga 节点的 Flex 方向</span><br><span class="line">void setFlexDirection(YGNodeRef node, const char* direction) &#123;</span><br><span class="line">    YGFlexDirection dir = YGFlexDirectionColumn;</span><br><span class="line">    if (strcmp(direction, &quot;row&quot;) == 0) &#123;</span><br><span class="line">        dir = YGFlexDirectionRow;</span><br><span class="line">    &#125; else if (strcmp(direction, &quot;column-reverse&quot;) == 0) &#123;</span><br><span class="line">        dir = YGFlexDirectionColumnReverse;</span><br><span class="line">    &#125; else if (strcmp(direction, &quot;row-reverse&quot;) == 0) &#123;</span><br><span class="line">        dir = YGFlexDirectionRowReverse;</span><br><span class="line">    &#125;</span><br><span class="line">    YGNodeStyleSetFlexDirection(node, dir);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 计算 Yoga 布局</span><br><span class="line">void calculateLayout(YGNodeRef node, float width, float height) &#123;</span><br><span class="line">    YGNodeCalculateLayout(node, width, height, YGDirectionLTR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 获取 Yoga 节点的布局属性</span><br><span class="line">float getLayoutLeft(YGNodeRef node) &#123;</span><br><span class="line">    return YGNodeLayoutGetLeft(node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float getLayoutTop(YGNodeRef node) &#123;</span><br><span class="line">    return YGNodeLayoutGetTop(node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float getLayoutWidth(YGNodeRef node) &#123;</span><br><span class="line">    return YGNodeLayoutGetWidth(node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float getLayoutHeight(YGNodeRef node) &#123;</span><br><span class="line">    return YGNodeLayoutGetHeight(node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 注册 JavaScript 函数</span><br><span class="line">void registerJSFunctions(JSContext* ctx) &#123;</span><br><span class="line">    JS_NewGlobalObject(ctx);</span><br><span class="line">    JSValue global_obj = JS_GetGlobalObject(ctx);</span><br><span class="line"></span><br><span class="line">    JS_SetPropertyStr(ctx, global_obj, &quot;createYogaNode&quot;, JS_NewCFunction(ctx, createYogaNode, &quot;createYogaNode&quot;, 0));</span><br><span class="line">    JS_SetPropertyStr(ctx, global_obj, &quot;setWidth&quot;, JS_NewCFunction(ctx, setWidth, &quot;setWidth&quot;, 2));</span><br><span class="line">    JS_SetPropertyStr(ctx, global_obj, &quot;setHeight&quot;, JS_NewCFunction(ctx, setHeight, &quot;setHeight&quot;, 2));</span><br><span class="line">    JS_SetPropertyStr(ctx, global_obj, &quot;setFlexDirection&quot;, JS_NewCFunction(ctx, setFlexDirection, &quot;setFlexDirection&quot;, 2));</span><br><span class="line">    JS_SetPropertyStr(ctx, global_obj, &quot;calculateLayout&quot;, JS_NewCFunction(ctx, calculateLayout, &quot;calculateLayout&quot;, 3));</span><br><span class="line">    JS_SetPropertyStr(ctx, global_obj, &quot;getLayoutLeft&quot;, JS_NewCFunction(ctx, getLayoutLeft, &quot;getLayoutLeft&quot;, 1));</span><br><span class="line">    JS_SetPropertyStr(ctx, global_obj, &quot;getLayoutTop&quot;, JS_NewCFunction(ctx, getLayoutTop, &quot;getLayoutTop&quot;, 1));</span><br><span class="line">    JS_SetPropertyStr(ctx, global_obj, &quot;getLayoutWidth&quot;, JS_NewCFunction(ctx, getLayoutWidth, &quot;getLayoutWidth&quot;, 1));</span><br><span class="line">    JS_SetPropertyStr(ctx, global_obj, &quot;getLayoutHeight&quot;, JS_NewCFunction(ctx, getLayoutHeight, &quot;getLayoutHeight&quot;, 1));</span><br><span class="line"></span><br><span class="line">    JS_FreeValue(ctx, global_obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char** argv) &#123;</span><br><span class="line">    JSRuntime* rt = JS_NewRuntime();</span><br><span class="line">    JSContext* ctx = JS_NewContext(rt);</span><br><span class="line"></span><br><span class="line">    registerJSFunctions(ctx);</span><br><span class="line"></span><br><span class="line">    // 读取并执行 JavaScript 代码</span><br><span class="line">    const char* js_code = R&quot;(</span><br><span class="line">        let root = createYogaNode();</span><br><span class="line">        setWidth(root, 300);</span><br><span class="line">        setHeight(root, 300);</span><br><span class="line">        setFlexDirection(root, &#x27;column&#x27;);</span><br><span class="line"></span><br><span class="line">        let child1 = createYogaNode();</span><br><span class="line">        setWidth(child1, 100);</span><br><span class="line">        setHeight(child1, 100);</span><br><span class="line"></span><br><span class="line">        let child2 = createYogaNode();</span><br><span class="line">        setWidth(child2, 100);</span><br><span class="line">        setHeight(child2, 100);</span><br><span class="line"></span><br><span class="line">        root.appendChild(child1);</span><br><span class="line">        root.appendChild(child2);</span><br><span class="line"></span><br><span class="line">        calculateLayout(root, 300, 300);</span><br><span class="line"></span><br><span class="line">        console.log(`Left: $&#123;getLayoutLeft(root)&#125;, Top: $&#123;getLayoutTop(root)&#125;, Width: $&#123;getLayoutWidth(root)&#125;, Height: $&#123;getLayoutHeight(root)&#125;`);</span><br><span class="line">        console.log(`Child1 Left: $&#123;getLayoutLeft(child1)&#125;, Top: $&#123;getLayoutTop(child1)&#125;, Width: $&#123;getLayoutWidth(child1)&#125;, Height: $&#123;getLayoutHeight(child1)&#125;`);</span><br><span class="line">        console.log(`Child2 Left: $&#123;getLayoutLeft(child2)&#125;, Top: $&#123;getLayoutTop(child2)&#125;, Width: $&#123;getLayoutWidth(child2)&#125;, Height: $&#123;getLayoutHeight(child2)&#125;`);</span><br><span class="line">    )&quot;;</span><br><span class="line"></span><br><span class="line">    JS_Eval(ctx, js_code, strlen(js_code), &quot;&lt;input&gt;&quot;, JS_EVAL_TYPE_GLOBAL);</span><br><span class="line"></span><br><span class="line">    JS_FreeContext(ctx);</span><br><span class="line">    JS_FreeRuntime(rt);</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">3. 编译和运行</span><br><span class="line">编译上述 C 代码，并链接 QuickJS 和 Yoga 库。假设你已经编译并安装了 QuickJS 和 Yoga，可以使用以下命令进行编译：</span><br><span class="line"></span><br><span class="line">gcc -o quickjs_yoga main.c -I/path/to/quickjs -I/path/to/yoga -L/path/to/quickjs -L/path/to/yoga -lquickjs -lyoga -lm</span><br><span class="line"></span><br><span class="line">运行编译后的程序：</span><br><span class="line">./quickjs_yoga</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">解释</span><br><span class="line">初始化 Yoga 节点:</span><br><span class="line"></span><br><span class="line">createYogaNode 函数创建一个新的 Yoga 节点。</span><br><span class="line">setWidth 和 setHeight 函数设置节点的宽度和高度。</span><br><span class="line">setFlexDirection 函数设置节点的 Flex 方向。</span><br><span class="line">计算布局:</span><br><span class="line"></span><br><span class="line">calculateLayout 函数计算节点的布局。</span><br><span class="line">获取布局属性:</span><br><span class="line"></span><br><span class="line">getLayoutLeft、getLayoutTop、getLayoutWidth 和 getLayoutHeight 函数获取节点的布局属性。</span><br><span class="line">注册 JavaScript 函数:</span><br><span class="line"></span><br><span class="line">registerJSFunctions 函数将 C 函数注册为 JavaScript 函数，使它们可以在 JavaScript 中调用。</span><br><span class="line">执行 JavaScript 代码:</span><br><span class="line"></span><br><span class="line">在 main 函数中，读取并执行 JavaScript 代码，创建和配置 Yoga 节点，并计算布局。</span><br><span class="line">运行结果</span><br><span class="line">当你运行上述程序时，JavaScript 代码将创建一个根节点和两个子节点，设置它们的布局属性，并计算布局。最终，程序将输出每个节点的布局属性。</span><br><span class="line"></span><br><span class="line">总结</span><br><span class="line">通过结合 QuickJS 和 Yoga，你可以在 JavaScript 中实现高效的布局管理，特别适合用于构建跨平台的应用程序。这种方式不仅提供了灵活的布局能力，还保持了高性能和低资源消耗。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yoga 编译安装</span><br><span class="line">oga 编译安装指南</span><br><span class="line">Yoga 是 Facebook 开发的一个跨平台的布局引擎，基于 Flexbox 布局算法。它支持多种平台，包括 iOS、Android、Web 和桌面应用。以下是如何在不同平台上编译和安装 Yoga 的详细步骤。</span><br><span class="line">1. 获取 Yoga 源代码</span><br><span class="line">首先，从 GitHub 上克隆 Yoga 仓库：</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install cmake ninja-build</span><br><span class="line"></span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake -G Ninja ..</span><br><span class="line">ninja</span><br><span class="line">编译完成后，你会在 build 目录下找到生成的库文件，例如 libyoga.a 或 libyoga.so。</span><br><span class="line">Windows</span><br><span class="line">使用 Visual Studio 命令行工具（例如 Developer Command Prompt for VS 2019）：</span><br><span class="line">shmkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake -G &quot;Visual Studio 16 2019&quot; -A x64 ..</span><br><span class="line">cmake --build . --config Release</span><br><span class="line">编译完成后，你会在 build\Release 目录下找到生成的库文件，例如 yoga.lib。</span><br><span class="line">4. 安装 Yoga</span><br><span class="line">Linux 和 macOS</span><br><span class="line">将生成的库文件和头文件复制到适当的位置。例如，复制到 /usr/local/lib 和 /usr/local/include：</span><br><span class="line">shsudo cp build/libyoga.a /usr/local/lib/</span><br><span class="line">sudo cp -r ../yoga /usr/local/include/</span><br><span class="line">Windows</span><br><span class="line">将生成的库文件和头文件复制到你的项目目录中。例如，复制到 C:\your_project\lib 和 C:\your_project\include：</span><br><span class="line">shcopy build\Release\yoga.lib C:\your_project\lib\</span><br><span class="line">xcopy ..\yoga C:\your_project\include\yoga /E /I</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5. 验证安装</span><br><span class="line">创建一个简单的 C++ 程序来验证 Yoga 是否安装成功。</span><br><span class="line">示例代码</span><br><span class="line">创建一个 test_yoga.cpp 文件：</span><br><span class="line">cpp#include &lt;iostream&gt;</span><br><span class="line">#include &lt;yoga/YGNode.h&gt;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    // 创建一个 Yoga 节点</span><br><span class="line">    YGNodeRef root = YGNodeNew();</span><br><span class="line">    YGNodeStyleSetWidth(root, 300);</span><br><span class="line">    YGNodeStyleSetHeight(root, 300);</span><br><span class="line"></span><br><span class="line">    // 计算布局</span><br><span class="line">    YGNodeCalculateLayout(root, YGUndefined, YGUndefined, YGDirectionLTR);</span><br><span class="line"></span><br><span class="line">    // 输出布局信息</span><br><span class="line">    std::cout &lt;&lt; &quot;Root node layout: &quot;</span><br><span class="line">              &lt;&lt; &quot;Left: &quot; &lt;&lt; YGNodeLayoutGetLeft(root) &lt;&lt; &quot;, &quot;</span><br><span class="line">              &lt;&lt; &quot;Top: &quot; &lt;&lt; YGNodeLayoutGetTop(root) &lt;&lt; &quot;, &quot;</span><br><span class="line">              &lt;&lt; &quot;Width: &quot; &lt;&lt; YGNodeLayoutGetWidth(root) &lt;&lt; &quot;, &quot;</span><br><span class="line">              &lt;&lt; &quot;Height: &quot; &lt;&lt; YGNodeLayoutGetHeight(root) &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    // 释放节点</span><br><span class="line">    YGNodeFreeRecursive(root);</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">编译和运行</span><br><span class="line">Linux 和 macOS</span><br><span class="line">shg++ test_yoga.cpp -lyoga -o test_yoga</span><br><span class="line">./test_yoga</span><br><span class="line">Windows</span><br><span class="line">使用 Visual Studio 命令行工具：</span><br><span class="line">shcl /EHsc /I C:\your_project\include test_yoga.cpp /link /LIBPATH:C:\your_project\lib yoga.lib</span><br><span class="line">test_yoga.exe</span><br><span class="line">总结</span><br><span class="line">通过以上步骤，你可以在不同的平台上编译和安装 Yoga，并验证其是否安装成功。Yoga 提供了强大的布局能力，适用于多种应用场景，特别是需要跨平台布局的项目。</span><br><span class="line"></span><br><span class="line">javascript 应该如何调用</span><br><span class="line">在你的代码中，已经将 C/C++ 函数注册到了 QuickJS 的全局对象中，这样你就可以在 JavaScript 中直接调用这些函数。以下是如何在 JavaScript 中调用这些函数的详细步骤和示例：</span><br><span class="line">1. 创建和配置 Yoga 节点</span><br><span class="line">你已经在 main 函数中定义了一段 JavaScript 代码，用于创建和配置 Yoga 节点。以下是这段代码的详细解释：</span><br><span class="line">javascriptlet root = createYogaNode();</span><br><span class="line">setWidth(root, 300);</span><br><span class="line">setHeight(root, 300);</span><br><span class="line">setFlexDirection(root, &#x27;column&#x27;);</span><br><span class="line">createYogaNode()：创建一个新的 Yoga 节点。</span><br><span class="line">setWidth(root, 300)：设置根节点的宽度为 300。</span><br><span class="line">setHeight(root, 300)：设置根节点的高度为 300。</span><br><span class="line">setFlexDirection(root, &#x27;column&#x27;)：设置根节点的 Flex 方向为列方向。</span><br><span class="line">2. 创建子节点并添加到根节点</span><br><span class="line">javascriptlet child1 = createYogaNode();</span><br><span class="line">setWidth(child1, 100);</span><br><span class="line">setHeight(child1, 100);</span><br><span class="line"></span><br><span class="line">let child2 = createYogaNode();</span><br><span class="line">setWidth(child2, 100);</span><br><span class="line">setHeight(child2, 100);</span><br><span class="line"></span><br><span class="line">root.appendChild(child1);</span><br><span class="line">root.appendChild(child2);</span><br><span class="line">createYogaNode()：创建两个子节点 child1 和 child2。</span><br><span class="line">setWidth(child1, 100) 和 setHeight(child1, 100)：设置 child1 的宽度和高度。</span><br><span class="line">setWidth(child2, 100) 和 setHeight(child2, 100)：设置 child2 的宽度和高度。</span><br><span class="line">root.appendChild(child1) 和 root.appendChild(child2)：将子节点添加到根节点中。</span><br><span class="line">3. 计算布局</span><br><span class="line">javascriptcalculateLayout(root, 300, 300);</span><br><span class="line">calculateLayout(root, 300, 300)：计算根节点及其子节点的布局，给定的宽度和高度分别为 300。</span><br><span class="line">4. 获取并输出布局属性</span><br><span class="line">javascriptconsole.log(`Left: $&#123;getLayoutLeft(root)&#125;, Top: $&#123;getLayoutTop(root)&#125;, Width: $&#123;getLayoutWidth(root)&#125;, Height: $&#123;getLayoutHeight(root)&#125;`);</span><br><span class="line">console.log(`Child1 Left: $&#123;getLayoutLeft(child1)&#125;, Top: $&#123;getLayoutTop(child1)&#125;, Width: $&#123;getLayoutWidth(child1)&#125;, Height: $&#123;getLayoutHeight(child1)&#125;`);</span><br><span class="line">console.log(`Child2 Left: $&#123;getLayoutLeft(child2)&#125;, Top: $&#123;getLayoutTop(child2)&#125;, Width: $&#123;getLayoutWidth(child2)&#125;, Height: $&#123;getLayoutHeight(child2)&#125;`);</span><br><span class="line">getLayoutLeft(node)：获取节点的左偏移。</span><br><span class="line">getLayoutTop(node)：获取节点的上偏移。</span><br><span class="line">getLayoutWidth(node)：获取节点的宽度。</span><br><span class="line">getLayoutHeight(node)：获取节点的高度。</span><br><span class="line">console.log()：输出节点的布局属性。</span><br><span class="line">完整的 JavaScript 代码</span><br><span class="line">javascriptlet root = createYogaNode();</span><br><span class="line">setWidth(root, 300);</span><br><span class="line">setHeight(root, 300);</span><br><span class="line">setFlexDirection(root, &#x27;column&#x27;);</span><br><span class="line"></span><br><span class="line">let child1 = createYogaNode();</span><br><span class="line">setWidth(child1, 100);</span><br><span class="line">setHeight(child1, 100);</span><br><span class="line"></span><br><span class="line">let child2 = createYogaNode();</span><br><span class="line">setWidth(child2, 100);</span><br><span class="line">setHeight(child2, 100);</span><br><span class="line"></span><br><span class="line">root.appendChild(child1);</span><br><span class="line">root.appendChild(child2);</span><br><span class="line"></span><br><span class="line">calculateLayout(root, 300, 300);</span><br><span class="line"></span><br><span class="line">console.log(`Left: $&#123;getLayoutLeft(root)&#125;, Top: $&#123;getLayoutTop(root)&#125;, Width: $&#123;getLayoutWidth(root)&#125;, Height: $&#123;getLayoutHeight(root)&#125;`);</span><br><span class="line">console.log(`Child1 Left: $&#123;getLayoutLeft(child1)&#125;, Top: $&#123;getLayoutTop(child1)&#125;, Width: $&#123;getLayoutWidth(child1)&#125;, Height: $&#123;getLayoutHeight(child1)&#125;`);</span><br><span class="line">console.log(`Child2 Left: $&#123;getLayoutLeft(child2)&#125;, Top: $&#123;getLayoutTop(child2)&#125;, Width: $&#123;getLayoutWidth(child2)&#125;, Height: $&#123;getLayoutHeight(child2)&#125;`);</span><br><span class="line">运行结果</span><br><span class="line">运行上述 JavaScript 代码后，你应该会看到类似以下的输出：</span><br><span class="line">Left: 0, Top: 0, Width: 300, Height: 300</span><br><span class="line">Child1 Left: 0, Top: 0, Width: 100, Height: 100</span><br><span class="line">Child2 Left: 0, Top: 100, Width: 100, Height: 100</span><br><span class="line">这表明 Yoga 节点的布局已经正确计算并输出。你可以根据需要修改 JavaScript 代码，以实现不同的布局效果。</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/nginx-njs-quickjs/" rel="tag"># nginx njs quickjs</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/12/13/pg/" rel="prev" title="pg postgres">
      <i class="fa fa-chevron-left"></i> pg postgres
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/12/13/njs/" rel="next" title="njs">
      njs <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B"><span class="nav-number">1.</span> <span class="nav-text">快速开始</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#quickjs-%E5%A6%82%E4%BD%95%E6%93%8D%E4%BD%9C-mysql"><span class="nav-number">2.</span> <span class="nav-text">quickjs 如何操作 mysql</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#quickjs-%E5%A6%82%E4%BD%95%E6%93%8D%E4%BD%9C-redis"><span class="nav-number">3.</span> <span class="nav-text">quickjs 如何操作 redis</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#quickjs-yoga%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">quickjs+yoga结合使用</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">wangzhiwei</p>
  <div class="site-description" itemprop="description">javascript nodejs web developer...</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">62</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">62</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wangzhiwei</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
